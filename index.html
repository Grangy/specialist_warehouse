<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Панель отгрузок склада</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Стили для чеклиста сборки */
        input[type="checkbox"]:disabled + span {
            opacity: 0.5;
        }
        
        /* Улучшения для мобильных устройств */
        @media (max-width: 768px) {
            /* Улучшенный скролл на мобильных */
            .overflow-x-auto {
                -webkit-overflow-scrolling: touch;
                scrollbar-width: thin;
            }
            
            /* Минимальный размер области нажатия для кнопок */
            button {
                min-height: 44px;
                min-width: 44px;
            }
            
            /* Улучшенная работа с input на мобильных */
            input[type="number"] {
                font-size: 16px; /* Предотвращает зум на iOS */
            }
        }
        
        /* Touch-friendly стили */
        .touch-manipulation {
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Адаптивная таблица без горизонтального скролла */
        #collect-modal-content table {
            table-layout: fixed;
            width: 100%;
        }
        
        @media (max-width: 768px) {
            #collect-modal-content table {
                table-layout: auto;
            }
            
            #collect-modal-content th,
            #collect-modal-content td {
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
        }
        
        /* Перенос длинных наименований на 2 строки */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            word-break: break-word;
        }
        
        /* Ограничение ширины колонки наименования на десктопе */
        @media (min-width: 768px) {
            #collect-modal-content .name-header-col {
                max-width: 200px !important;
                width: 200px !important;
            }
            
            /* Компактная таблица без горизонтального скролла */
            #collect-modal-content table {
                font-size: 0.75rem;
            }
            
            #collect-modal-content th,
            #collect-modal-content td {
                padding: 0.375rem 0.5rem;
            }
        }
        
        /* Swipe to confirm стили */
        #swipe-confirm-container {
            touch-action: pan-x;
        }
        
        #swipe-confirm-slider {
            min-width: 60px;
        }
        
        #swipe-confirm-text {
            transition: opacity 0.3s;
        }
        
        #swipe-confirm-container.swiping #swipe-confirm-text {
            opacity: 0.5;
        }
        
        #swipe-confirm-container.completed #swipe-confirm-slider {
            background: #10b981;
        }
        
        #swipe-confirm-container.completed #swipe-confirm-text {
            color: white;
            font-weight: bold;
        }
        
        /* Swipe to collect стили для каждого товара */
        [id^="swipe-collect-track-"] {
            touch-action: pan-x;
            user-select: none;
            -webkit-user-select: none;
        }
        
        [id^="swipe-collect-slider-"] {
            transition: width 0.1s linear;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            z-index: 2;
        }
        
        [id^="swipe-collect-text-"] {
            transition: opacity 0.2s, color 0.2s;
            white-space: nowrap;
        }
        
        .swiping-collect [id^="swipe-collect-text-"] {
            opacity: 0.7;
        }
        
        .swiping-collect [id^="swipe-collect-slider-"] {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        }
        
        .completed-collect [id^="swipe-collect-slider-"] {
            background: #10b981 !important;
            width: 100% !important;
        }
        
        .completed-collect [id^="swipe-collect-text-"] {
            color: white !important;
            font-weight: bold;
        }
        
        [id^="swipe-collect-track-"]:active {
            border-color: #3b82f6;
        }
        
        /* Swipe to confirm item стили (для режима подтверждения) */
        [id^="swipe-confirm-item-track-"] {
            touch-action: pan-x;
            user-select: none;
            -webkit-user-select: none;
        }
        
        [id^="swipe-confirm-item-slider-"] {
            transition: width 0.1s linear;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            z-index: 2;
        }
        
        [id^="swipe-confirm-item-text-"] {
            transition: opacity 0.2s, color 0.2s;
            white-space: nowrap;
        }
        
        .swiping-confirm-item [id^="swipe-confirm-item-text-"] {
            opacity: 0.7;
        }
        
        .swiping-confirm-item [id^="swipe-confirm-item-slider-"] {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        }
        
        .completed-confirm-item [id^="swipe-confirm-item-slider-"] {
            background: #10b981 !important;
            width: 100% !important;
        }
        
        .completed-confirm-item [id^="swipe-confirm-item-text-"] {
            color: white !important;
            font-weight: bold;
        }
        
        [id^="swipe-confirm-item-track-"]:active {
            border-color: #3b82f6;
        }

        /* Tooltip для полного наименования */
        .name-tooltip {
            position: relative;
            cursor: pointer;
            display: inline-block;
            width: 100%;
        }
        
        .name-tooltip-content {
            position: fixed;
            background: rgba(15, 23, 42, 0.98);
            color: white;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 13px;
            white-space: normal;
            max-width: 90vw;
            width: auto;
            z-index: 10000;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.3);
            display: none;
            word-wrap: break-word;
            pointer-events: none;
        }
        
        .name-tooltip:hover .name-tooltip-content,
        .name-tooltip.active .name-tooltip-content {
            display: block;
        }
        
        @media (max-width: 768px) {
            .name-tooltip-content {
                max-width: 85vw;
                font-size: 12px;
                padding: 8px 12px;
            }
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
    <!-- Хедер -->
    <header class="bg-slate-900 border-b border-slate-800 px-3 md:px-6 py-3 md:py-4">
        <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-3 md:gap-0 max-w-7xl mx-auto">
            <div class="flex items-center gap-2 md:gap-3 flex-shrink-0">
                <svg class="w-6 h-6 md:w-8 md:h-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                </svg>
                <h1 class="text-lg md:text-2xl font-bold text-slate-100 whitespace-nowrap">Панель отгрузки</h1>
            </div>
            <div class="flex items-center gap-2 md:gap-6 flex-wrap w-full md:w-auto justify-between md:justify-end">
                <div class="flex items-center gap-1.5 md:gap-2">
                    <span class="text-xs md:text-sm text-slate-400 whitespace-nowrap">Новых:</span>
                    <span id="new-count" class="bg-blue-600 text-white px-2 md:px-3 py-0.5 md:py-1 rounded-full text-xs md:text-sm font-semibold">0</span>
                </div>
                <div class="flex items-center gap-1.5 md:gap-2">
                    <span class="text-xs md:text-sm text-slate-400 whitespace-nowrap">Подтверждения:</span>
                    <span id="processed-count" class="bg-green-600 text-white px-2 md:px-3 py-0.5 md:py-1 rounded-full text-xs md:text-sm font-semibold">0</span>
                </div>
                <button id="refresh-btn" class="bg-slate-800 hover:bg-slate-700 text-slate-100 px-3 md:px-4 py-1.5 md:py-2 rounded-lg transition-colors flex items-center gap-1.5 md:gap-2 text-xs md:text-base touch-manipulation">
                    <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    <span class="hidden sm:inline">Обновить</span>
                    <span class="sm:hidden">Обн.</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Панель фильтров -->
    <div class="bg-slate-900 border-b border-slate-800 px-3 md:px-6 py-3 md:py-4">
        <div class="max-w-7xl mx-auto flex flex-wrap items-center gap-3 md:gap-4">
            <div class="flex-1 min-w-0 md:min-w-[300px] w-full md:w-auto">
                <div class="relative">
                    <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <input type="text" id="search-input" placeholder="Поиск по номеру или клиенту..." 
                           class="w-full bg-slate-800 border border-slate-700 text-slate-100 rounded-lg pl-10 pr-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            <select id="destination-filter" class="bg-slate-800 border border-slate-700 text-slate-100 rounded-lg px-3 md:px-4 py-2 text-sm md:text-base focus:outline-none focus:ring-2 focus:ring-blue-500 w-full md:w-auto">
                <option value="">Все направления</option>
            </select>
            <div class="flex items-center gap-2 w-full md:w-auto">
                <input type="checkbox" id="urgent-filter" class="w-4 h-4 text-blue-600 bg-slate-800 border-slate-700 rounded focus:ring-blue-500 flex-shrink-0">
                <label for="urgent-filter" class="text-xs md:text-sm text-slate-300 cursor-pointer whitespace-nowrap">Только срочные</label>
            </div>
        </div>
    </div>

    <!-- Основной контент -->
    <main class="max-w-7xl mx-auto px-3 md:px-6 py-4 md:py-6">
        <!-- Вкладки -->
        <div class="flex gap-2 mb-6 border-b border-slate-800">
            <button id="tab-new" class="tab-btn active px-6 py-3 font-semibold text-slate-300 border-b-2 border-blue-500 transition-colors">
                Новые
            </button>
            <button id="tab-processed" class="tab-btn px-6 py-3 font-semibold text-slate-400 border-b-2 border-transparent hover:text-slate-300 transition-colors">
                Подтверждения <span id="tab-processed-count" class="ml-1">(0)</span>
            </button>
        </div>

        <!-- Сетка карточек -->
        <div id="cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Карточки будут добавлены через JavaScript -->
        </div>

        <!-- Состояние "нет данных" -->
        <div id="empty-state" class="hidden text-center py-16">
            <svg class="w-24 h-24 mx-auto text-slate-700 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
            </svg>
            <p class="text-xl text-slate-400 mb-2">Нет заказов</p>
            <p class="text-slate-500">Заказы появятся здесь после загрузки</p>
        </div>

        <!-- Состояние загрузки -->
        <div id="loading-state" class="hidden text-center py-16">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
            <p class="text-slate-400 mt-4">Загрузка заказов...</p>
        </div>
    </main>

    <!-- Модальное окно сборки -->
    <div id="collect-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-0 md:p-4" style="touch-action: none; overscroll-behavior: none;">
        <div class="bg-slate-800 rounded-none md:rounded-lg shadow-2xl max-w-7xl w-full h-full md:h-auto md:max-h-[95vh] overflow-hidden border-0 md:border border-slate-700 flex flex-col" style="touch-action: auto;">
            <div class="flex items-center justify-between p-4 md:p-6 border-b border-slate-700 sticky top-0 bg-slate-800 z-20 flex-shrink-0">
                <div class="flex-1 min-w-0">
                    <h2 class="text-lg md:text-xl font-bold text-slate-100">Сборка заказа</h2>
                    <p id="collect-modal-number" class="text-xs md:text-sm text-slate-400 mt-1 truncate"></p>
                    <p id="collect-modal-business-region" class="text-xs md:text-sm text-blue-400 mt-1"></p>
                </div>
                <button id="close-collect-modal" class="text-slate-400 hover:text-slate-100 transition-colors ml-2 flex-shrink-0">
                    <svg class="w-6 h-6 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="p-3 md:p-6 overflow-y-auto flex-1 overscroll-contain" style="overscroll-behavior: contain; -webkit-overflow-scrolling: touch;">
                <div id="collect-modal-content" class="space-y-4">
                    <!-- Чеклист будет добавлен через JavaScript -->
                </div>
            </div>
            <div class="p-4 md:p-6 border-t border-slate-700">
                <div class="flex items-center justify-between mb-4">
                    <div class="text-sm text-slate-400">
                        Прогресс: <span id="collect-progress" class="font-semibold text-slate-100">0/0</span>
                    </div>
                    <div id="collect-status" class="text-sm"></div>
                </div>
                <div class="flex flex-col sm:flex-row gap-2 sm:gap-3">
                    <!-- Мобильная версия: swipe-to-confirm -->
                    <div id="swipe-confirm-container" class="md:hidden w-full relative overflow-hidden rounded-lg">
                        <div id="swipe-confirm-track" class="relative w-full h-14 bg-slate-700 rounded-lg overflow-hidden">
                            <div id="swipe-confirm-slider" class="absolute left-0 top-0 h-full bg-blue-600 flex items-center justify-center transition-all duration-300 ease-out" style="width: 0%; min-width: 60px;">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                            <div id="swipe-confirm-text" class="absolute inset-0 flex items-center justify-center text-slate-200 font-semibold text-sm pointer-events-none z-10">
                                <span>Сдвиньте вправо для подтверждения →</span>
                            </div>
                        </div>
                    </div>
                    <!-- Десктоп версия: обычная кнопка -->
                    <button id="confirm-collect-btn" class="hidden md:flex flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-slate-600 disabled:cursor-not-allowed text-white font-semibold py-3 px-4 md:px-6 rounded-lg transition-colors items-center justify-center gap-2" disabled>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span class="text-sm md:text-base">Подтвердить обработку</span>
                    </button>
                    <button id="cancel-collect-btn" class="bg-slate-700 hover:bg-slate-600 text-slate-100 font-semibold py-3 md:py-3 px-4 md:px-6 rounded-lg transition-colors touch-manipulation">
                        Отмена
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно подтверждения -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-0 md:p-4" style="touch-action: none; overscroll-behavior: none;">
        <div class="bg-slate-800 rounded-none md:rounded-lg shadow-2xl max-w-7xl w-full h-full md:h-auto md:max-h-[95vh] overflow-hidden border-0 md:border border-slate-700 flex flex-col" style="touch-action: auto;">
            <div class="flex items-center justify-between p-4 md:p-6 border-b border-slate-700 sticky top-0 bg-slate-800 z-20 flex-shrink-0">
                <div class="flex-1 min-w-0">
                    <h2 class="text-lg md:text-xl font-bold text-slate-100">Подтверждение сборки</h2>
                    <p id="confirm-modal-number" class="text-xs md:text-sm text-slate-400 mt-1 truncate"></p>
                    <p id="confirm-modal-collector" class="text-xs md:text-sm text-yellow-400 mt-1"></p>
                </div>
                <button id="close-confirm-modal" class="text-slate-400 hover:text-slate-100 transition-colors ml-2 flex-shrink-0">
                    <svg class="w-6 h-6 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="p-3 md:p-6 overflow-y-auto flex-1 overscroll-contain" style="overscroll-behavior: contain; -webkit-overflow-scrolling: touch;">
                <div id="confirm-warnings" class="mb-4"></div>
                <div id="confirm-modal-content" class="space-y-4">
                    <!-- Чеклист будет добавлен через JavaScript -->
                </div>
            </div>
            <div class="p-4 md:p-6 border-t border-slate-700">
                <div class="flex items-center justify-between mb-4">
                    <div class="text-sm text-slate-400">
                        <span id="confirm-progress" class="font-semibold text-slate-100">Подтверждено: 0/0</span>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row gap-2 sm:gap-3">
                    <button id="confirm-shipment-btn" class="flex-1 bg-green-600 hover:bg-green-700 disabled:bg-slate-600 disabled:cursor-not-allowed text-white font-semibold py-3 md:py-3 px-4 md:px-6 rounded-lg transition-colors flex items-center justify-center gap-2 touch-manipulation" disabled>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span class="text-sm md:text-base">Подтвердить</span>
                    </button>
                    <button id="cancel-confirm-btn" class="bg-slate-700 hover:bg-slate-600 text-slate-100 font-semibold py-3 md:py-3 px-4 md:px-6 rounded-lg transition-colors touch-manipulation">
                        Отмена
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно полного названия товара -->
    <div id="name-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[60] p-4">
        <div class="bg-slate-800 rounded-lg shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-hidden border border-slate-700 flex flex-col">
            <div class="flex items-center justify-between p-4 md:p-6 border-b border-slate-700">
                <h2 class="text-xl md:text-2xl font-bold text-slate-100">Информация о товаре</h2>
                <button id="close-name-modal" class="text-slate-400 hover:text-slate-100 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="p-4 md:p-6 overflow-y-auto flex-1">
                <div class="space-y-4">
                    <div>
                        <div class="text-sm md:text-base text-slate-400 mb-2">Наименование</div>
                        <p id="name-modal-name" class="text-lg md:text-xl text-slate-100 leading-relaxed whitespace-pre-wrap break-words font-medium"></p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <div class="text-sm md:text-base text-slate-400 mb-2">Артикул</div>
                            <p id="name-modal-sku" class="text-base md:text-lg text-slate-100 font-medium"></p>
                        </div>
                        <div>
                            <div class="text-sm md:text-base text-slate-400 mb-2">Место</div>
                            <p id="name-modal-location" class="text-base md:text-lg text-blue-400 font-medium"></p>
                        </div>
                        <div>
                            <div class="text-sm md:text-base text-slate-400 mb-2">Требуется</div>
                            <p id="name-modal-qty" class="text-base md:text-lg text-slate-100 font-medium"></p>
                        </div>
                        <div>
                            <div class="text-sm md:text-base text-slate-400 mb-2">Собрано</div>
                            <p id="name-modal-collected" class="text-base md:text-lg text-slate-100 font-medium"></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 md:p-6 border-t border-slate-700">
                <button id="close-name-modal-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 md:py-3 px-4 rounded-lg transition-colors text-base md:text-lg">
                    Закрыть
                </button>
            </div>
        </div>
    </div>

    <!-- Модальное окно деталей -->
    <div id="details-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-slate-800 rounded-lg shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden border border-slate-700 flex flex-col">
            <div class="flex items-center justify-between p-6 border-b border-slate-700">
                <h2 id="details-modal-title" class="text-xl font-bold text-slate-100">Детали заказа</h2>
                <button id="close-details-modal" class="text-slate-400 hover:text-slate-100 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="p-6 overflow-y-auto flex-1">
                <div id="details-modal-content">
                    <!-- Контент будет добавлен через JavaScript -->
                </div>
            </div>
            <div class="p-6 border-t border-slate-700 flex gap-3">
                <button id="collect-from-details-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                    </svg>
                    Собрать
                </button>
                <button id="save-details-btn" class="hidden bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    Сохранить изменения
                </button>
                <button id="close-details-btn" class="bg-slate-700 hover:bg-slate-600 text-slate-100 font-semibold py-3 px-6 rounded-lg transition-colors">
                    Закрыть
                </button>
            </div>
        </div>
    </div>

    <!-- Тосты для ошибок -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <script>
        // Конфигурация API
        const API_BASE = '/api';
        const API_ENDPOINTS = {
            shipments: `${API_BASE}/shipments`,
            markProcessed: (id) => `${API_BASE}/shipments/${id}/processed`,
            markPendingConfirmation: (id) => `${API_BASE}/shipments/${id}/pending_confirmation`,
            confirmShipment: (id) => `${API_BASE}/shipments/${id}/confirm`,
            lock: (id) => `${API_BASE}/shipments/${id}/lock`,
            unlock: (id) => `${API_BASE}/shipments/${id}/unlock`
        };

        // Генерация уникального ID пользователя (в реальном приложении это был бы ID из сессии)
        const USER_ID = `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

        // Состояние приложения
        let allShipments = [];
        let filteredShipments = [];
        let currentTab = 'new';
        let currentPrintShipment = null;
        let autoRefreshInterval = null;
        let lockedShipmentId = null; // ID заблокированного заказа

        // Инициализация
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            loadShipments();
            startAutoRefresh();
        });

        // Разблокировка заказа при закрытии страницы
        window.addEventListener('beforeunload', () => {
            if (lockedShipmentId) {
                // Используем navigator.sendBeacon для надежной отправки даже при закрытии
                const formData = new FormData();
                formData.append('userId', USER_ID);
                navigator.sendBeacon(
                    API_ENDPOINTS.unlock(lockedShipmentId),
                    formData
                );
            }
        });

        // Настройка обработчиков событий
        function setupEventListeners() {
            // Вкладки
            document.getElementById('tab-new').addEventListener('click', () => switchTab('new'));
            document.getElementById('tab-processed').addEventListener('click', () => switchTab('processed'));

            // Кнопка обновления
            document.getElementById('refresh-btn').addEventListener('click', loadShipments);

            // Фильтры
            document.getElementById('search-input').addEventListener('input', applyFilters);
            document.getElementById('destination-filter').addEventListener('change', applyFilters);
            document.getElementById('urgent-filter').addEventListener('change', applyFilters);

            // Модальные окна
            document.getElementById('close-collect-modal').addEventListener('click', closeCollectModal);
            document.getElementById('cancel-collect-btn').addEventListener('click', closeCollectModal);
            document.getElementById('confirm-collect-btn').addEventListener('click', confirmProcessing);
            document.getElementById('close-confirm-modal').addEventListener('click', closeConfirmModal);
            document.getElementById('cancel-confirm-btn').addEventListener('click', closeConfirmModal);
            document.getElementById('confirm-shipment-btn').addEventListener('click', confirmShipment);
            document.getElementById('close-details-modal').addEventListener('click', closeDetailsModal);
            document.getElementById('close-details-btn').addEventListener('click', closeDetailsModal);
            document.getElementById('close-name-modal').addEventListener('click', closeNameModal);
            document.getElementById('close-name-modal-btn').addEventListener('click', closeNameModal);
            document.getElementById('collect-from-details-btn').addEventListener('click', () => {
                if (currentPrintShipment) {
                    closeDetailsModal();
                    openCollectModal(currentPrintShipment);
                }
            });
            document.getElementById('save-details-btn').addEventListener('click', saveDetailsChanges);

            // Закрытие модалок по клику на фон
            document.getElementById('collect-modal').addEventListener('click', (e) => {
                if (e.target.id === 'collect-modal') closeCollectModal();
            });
            
            document.getElementById('confirm-modal').addEventListener('click', (e) => {
                if (e.target.id === 'confirm-modal') closeConfirmModal();
            });
            
            // Разблокировка при закрытии через ESC
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && lockedShipmentId) {
                    const modal = document.getElementById('collect-modal');
                    if (!modal.classList.contains('hidden')) {
                        closeCollectModal();
                    }
                }
            });
            document.getElementById('details-modal').addEventListener('click', (e) => {
                if (e.target.id === 'details-modal') closeDetailsModal();
            });
            
            document.getElementById('name-modal').addEventListener('click', (e) => {
                if (e.target.id === 'name-modal') closeNameModal();
            });
            
            // Закрытие модального окна названия по Escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    const nameModal = document.getElementById('name-modal');
                    if (!nameModal.classList.contains('hidden')) {
                        closeNameModal();
                    }
                }
            });
        }

        // Загрузка заказов
        async function loadShipments() {
            const loadingEl = document.getElementById('loading-state');
            const emptyEl = document.getElementById('empty-state');
            const containerEl = document.getElementById('cards-container');

            loadingEl.classList.remove('hidden');
            emptyEl.classList.add('hidden');
            containerEl.innerHTML = '';

            try {
                // Передаем userId для фильтрации заблокированных заказов
                const response = await fetch(`${API_ENDPOINTS.shipments}?userId=${USER_ID}`);
                if (!response.ok) throw new Error('Ошибка загрузки данных');
                
                allShipments = await response.json();
                updateCounters();
                applyFilters();
            } catch (error) {
                showToast('Ошибка загрузки данных, попробуйте обновить страницу', 'error');
                console.error('Ошибка загрузки:', error);
            } finally {
                loadingEl.classList.add('hidden');
            }
        }

        // Обновление счётчиков
        function updateCounters() {
            const newCount = allShipments.filter(s => s.status === 'new').length;
            const pendingConfirmationCount = allShipments.filter(s => s.status === 'pending_confirmation').length;
            
            document.getElementById('new-count').textContent = newCount;
            document.getElementById('processed-count').textContent = pendingConfirmationCount;
            document.getElementById('tab-processed-count').textContent = `(${pendingConfirmationCount})`;
        }

        // Переключение вкладок
        function switchTab(tab) {
            currentTab = tab;
            
            document.getElementById('tab-new').classList.toggle('active', tab === 'new');
            document.getElementById('tab-new').classList.toggle('border-blue-500', tab === 'new');
            document.getElementById('tab-new').classList.toggle('text-slate-300', tab === 'new');
            document.getElementById('tab-new').classList.toggle('text-slate-400', tab !== 'new');
            
            document.getElementById('tab-processed').classList.toggle('active', tab === 'processed');
            document.getElementById('tab-processed').classList.toggle('border-blue-500', tab === 'processed');
            document.getElementById('tab-processed').classList.toggle('text-slate-300', tab === 'processed');
            document.getElementById('tab-processed').classList.toggle('text-slate-400', tab !== 'processed');

            applyFilters();
        }

        // Применение фильтров
        function applyFilters() {
            const search = document.getElementById('search-input').value.toLowerCase();
            const destination = document.getElementById('destination-filter').value;
            const urgentOnly = document.getElementById('urgent-filter').checked;

            // Фильтрация по вкладке
            filteredShipments = allShipments.filter(shipment => {
                if (currentTab === 'new' && shipment.status !== 'new') return false;
                if (currentTab === 'processed' && shipment.status !== 'pending_confirmation') return false;
                return true;
            });

            // Фильтрация по поиску
            if (search) {
                filteredShipments = filteredShipments.filter(shipment => {
                    return shipment.number.toLowerCase().includes(search) ||
                           shipment.customer_name.toLowerCase().includes(search);
                });
            }

            // Фильтрация по направлению
            if (destination) {
                filteredShipments = filteredShipments.filter(shipment => 
                    shipment.destination === destination
                );
            }

            // Фильтрация по срочности
            if (urgentOnly) {
                filteredShipments = filteredShipments.filter(shipment => 
                    shipment.comment && shipment.comment.toLowerCase().includes('сроч')
                );
            }

            renderCards();
            updateDestinationFilter();
        }

        // Обновление фильтра направлений
        function updateDestinationFilter() {
            const select = document.getElementById('destination-filter');
            const destinations = [...new Set(allShipments.map(s => s.destination).filter(Boolean))];
            const currentValue = select.value;

            // Сохраняем текущее значение, если оно есть
            select.innerHTML = '<option value="">Все направления</option>';
            destinations.forEach(dest => {
                const option = document.createElement('option');
                option.value = dest;
                option.textContent = dest;
                select.appendChild(option);
            });

            if (currentValue && destinations.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        // Рендеринг карточек
        function renderCards() {
            const container = document.getElementById('cards-container');
            const emptyState = document.getElementById('empty-state');

            if (filteredShipments.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            container.innerHTML = filteredShipments.map(shipment => createCard(shipment)).join('');
        }

        // Создание карточки заказа
        function createCard(shipment) {
            const isProcessed = shipment.status === 'processed';
            const isPendingConfirmation = shipment.status === 'pending_confirmation';
            const isUrgent = shipment.comment && shipment.comment.toLowerCase().includes('сроч');
            const date = new Date(shipment.created_at);
            const formattedDate = date.toLocaleString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            const borderClass = isProcessed ? 'border-green-500 border-2' : isPendingConfirmation ? 'border-yellow-500 border-2' : 'border-slate-700';
            const bgClass = isProcessed ? 'bg-slate-800' : isPendingConfirmation ? 'bg-slate-800' : 'bg-slate-900';

            return `
                <div class="${bgClass} ${borderClass} rounded-lg p-5 shadow-lg hover:shadow-xl transition-shadow flex flex-col">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-lg font-bold text-slate-100">${escapeHtml(shipment.number)}</span>
                                ${isProcessed ? `
                                    <span class="bg-green-600 text-white text-xs font-semibold px-2 py-1 rounded flex items-center gap-1">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                        Обработано
                                    </span>
                                ` : isPendingConfirmation ? `
                                    <span class="bg-yellow-600 text-white text-xs font-semibold px-2 py-1 rounded flex items-center gap-1">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        Ожидает подтверждения
                                    </span>
                                ` : `
                                    <span class="bg-blue-600 text-white text-xs font-semibold px-2 py-1 rounded">Новый</span>
                                `}
                                ${isUrgent ? `
                                    <span class="bg-red-600 text-white text-xs font-semibold px-2 py-1 rounded">СРОЧНО</span>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3 space-y-1">
                        <div class="text-slate-300 font-medium">${escapeHtml(shipment.customer_name)}</div>
                        <div class="text-slate-400 text-sm">${escapeHtml(shipment.destination)}</div>
                    </div>

                    <div class="flex flex-wrap gap-3 mb-4 text-sm text-slate-400">
                        <div class="flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            ${formattedDate}
                        </div>
                        <div>${shipment.items_count} поз.</div>
                        <div>${shipment.total_qty} ед.</div>
                        ${shipment.weight ? `<div>${shipment.weight} кг</div>` : ''}
                    </div>

                    ${isPendingConfirmation && shipment.collector_name ? `
                        <div class="mb-3 text-sm">
                            <span class="text-slate-400">Сборщик:</span>
                            <span class="text-slate-200 font-medium ml-1">${escapeHtml(shipment.collector_name)}</span>
                        </div>
                    ` : ''}

                    ${(isProcessed || isPendingConfirmation) && shipment.lines ? (() => {
                        const hasShortages = shipment.lines.some(line => line.collected_qty !== undefined && line.collected_qty < line.qty && line.collected_qty > 0);
                        const hasZeroItems = shipment.lines.some(line => line.collected_qty !== undefined && line.collected_qty === 0);
                        const shortageCount = shipment.lines.filter(line => line.collected_qty !== undefined && line.collected_qty < line.qty && line.collected_qty > 0).length;
                        const zeroCount = shipment.lines.filter(line => line.collected_qty !== undefined && line.collected_qty === 0).length;
                        const totalShortage = shipment.lines.reduce((sum, line) => {
                            if (line.collected_qty !== undefined && line.collected_qty < line.qty) {
                                return sum + (line.qty - line.collected_qty);
                            }
                            return sum;
                        }, 0);
                        
                        if (hasZeroItems || hasShortages) {
                            return `
                                <div class="mb-4 p-3 ${hasZeroItems ? 'bg-red-900/20 border-red-700/50' : 'bg-yellow-900/20 border-yellow-700/50'} border rounded-lg">
                                    <div class="flex items-center gap-2 mb-1">
                                        <svg class="w-4 h-4 ${hasZeroItems ? 'text-red-500' : 'text-yellow-500'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                        </svg>
                                        <span class="${hasZeroItems ? 'text-red-400' : 'text-yellow-400'} font-semibold text-sm">
                                            ${hasZeroItems ? 'Есть не собранные товары' : 'Были корректировки при сборке'}
                                        </span>
                                    </div>
                                    <div class="text-xs ${hasZeroItems ? 'text-red-300' : 'text-yellow-300'}">
                                        ${hasZeroItems ? `${zeroCount} позиций не собрано` : ''}${hasZeroItems && hasShortages ? ' • ' : ''}${hasShortages ? `${shortageCount} позиций с недостачей` : ''}${(hasZeroItems || hasShortages) ? ` • Всего не хватает: ${totalShortage} ед.` : ''}
                                    </div>
                                </div>
                            `;
                        }
                        return '';
                    })() : ''}

                    ${shipment.comment ? `
                        <div class="mb-4 text-sm text-slate-400 italic">
                            ${escapeHtml(shipment.comment)}
                        </div>
                    ` : ''}

                    <div class="mt-auto flex gap-2">
                        ${isPendingConfirmation ? `
                            <button onclick="openConfirmModal(${JSON.stringify(shipment).replace(/"/g, '&quot;')})" 
                                    class="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                Подтвердить
                            </button>
                        ` : !isProcessed ? `
                            <button onclick="openCollectModal(${JSON.stringify(shipment).replace(/"/g, '&quot;')})" 
                                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                </svg>
                                Собрать
                            </button>
                        ` : ''}
                        <button onclick="openDetailsModal(${JSON.stringify(shipment).replace(/"/g, '&quot;')})" 
                                class="flex-1 bg-slate-700 hover:bg-slate-600 text-slate-100 font-semibold py-2 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                            Подробнее
                        </button>
                    </div>
                </div>
            `;
        }

        // Состояние чеклиста сборки
        let collectChecklistState = {};
        let collectEditState = {}; // Состояние редактирования для каждой строки
        let confirmEditState = {}; // Состояние редактирования для режима подтверждения
        let confirmChecklistState = {}; // Состояние чеклиста для режима подтверждения
        
        // Состояние проверки для обработанных заказов
        let detailsEditState = {}; // Состояние редактирования в деталях

        // Открытие модального окна сборки
        async function openCollectModal(shipment) {
            // Пытаемся заблокировать заказ
            try {
                const lockResponse = await fetch(API_ENDPOINTS.lock(shipment.id), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ userId: USER_ID })
                });

                if (!lockResponse.ok) {
                    const errorData = await lockResponse.json();
                    if (lockResponse.status === 409) {
                        showToast('Этот заказ уже взят в работу другим пользователем', 'error');
                        // Обновляем список заказов
                        loadShipments();
                        return;
                    }
                    throw new Error(errorData.error || 'Ошибка блокировки заказа');
                }

                // Заказ успешно заблокирован
                lockedShipmentId = shipment.id;
                
                // Обновляем список заказов, чтобы другие пользователи не видели этот заказ
                loadShipments();
            } catch (error) {
                showToast('Ошибка при блокировке заказа', 'error');
                console.error('Ошибка блокировки:', error);
                return;
            }

            currentPrintShipment = shipment;
            const modal = document.getElementById('collect-modal');
            const content = document.getElementById('collect-modal-content');
            const numberEl = document.getElementById('collect-modal-number');
            
            // Инициализация состояния чеклиста
            collectChecklistState = {};
            collectEditState = {}; // Сбрасываем состояние редактирования
            if (shipment.lines && shipment.lines.length > 0) {
                shipment.lines.forEach((line, index) => {
                    collectChecklistState[index] = {
                        collected: false,
                        qty: line.qty, // Требуемое количество
                        collectedQty: line.qty // Собранное количество (по умолчанию равно требуемому)
                    };
                });
            }

            numberEl.textContent = `Заказ ${escapeHtml(shipment.number)} • ${escapeHtml(shipment.customer_name)}`;
            
            // Отображаем бизнес-регион
            const businessRegionEl = document.getElementById('collect-modal-business-region');
            if (businessRegionEl) {
                if (shipment.business_region) {
                    businessRegionEl.textContent = `Бизнес-регион: ${escapeHtml(shipment.business_region)}`;
                    businessRegionEl.classList.remove('hidden');
                } else {
                    businessRegionEl.classList.add('hidden');
                }
            }

            // Создание чеклиста с пошаговой навигацией
            renderCollectChecklist();

            updateCollectProgress();
            
            // Инициализируем swipe-to-confirm после открытия модального окна
            setTimeout(() => {
                initSwipeToConfirm();
            }, 100);
            
            // Инициализируем swipe-to-collect с большей задержкой для гарантии рендеринга
            setTimeout(() => {
                initSwipeToCollect();
            }, 200);
            
            modal.classList.remove('hidden');
            // Блокируем скролл body на мобильных
            document.body.style.overflow = 'hidden';
            document.body.style.position = 'fixed';
            document.body.style.width = '100%';
        }

        // Рендеринг чеклиста сборки в виде таблицы
        function renderCollectChecklist() {
            if (!currentPrintShipment || !currentPrintShipment.lines || currentPrintShipment.lines.length === 0) {
                document.getElementById('collect-modal-content').innerHTML = '<p class="text-slate-400 text-center py-8">Нет позиций для сборки</p>';
                return;
            }

            const content = document.getElementById('collect-modal-content');
            
            // Сохраняем позицию скролла перед перерисовкой
            // Скроллируемый контейнер находится в родительском элементе модального окна
            let savedScrollTop = 0;
            const modalScrollContainer = document.querySelector('#collect-modal .overflow-y-auto');
            if (modalScrollContainer) {
                savedScrollTop = modalScrollContainer.scrollTop;
            }
            const totalItems = currentPrintShipment.lines.length;
            const collectedCount = currentPrintShipment.lines.filter((_, idx) => 
                collectChecklistState[idx]?.collected
            ).length;

            // Сортируем индексы: сначала несобранные, потом собранные
            const sortedIndices = currentPrintShipment.lines
                .map((_, index) => index)
                .sort((a, b) => {
                    const aCollected = collectChecklistState[a]?.collected || false;
                    const bCollected = collectChecklistState[b]?.collected || false;
                    // Несобранные (false) идут первыми, собранные (true) - внизу
                    if (aCollected === bCollected) return 0;
                    return aCollected ? 1 : -1;
                });

            content.innerHTML = `
                <div class="mb-2 md:mb-4 flex flex-col md:flex-row items-start md:items-center justify-between gap-1 md:gap-2 px-1 md:px-0">
                    <div class="text-[10px] md:text-sm text-slate-400">
                        Всего: <span class="font-semibold text-slate-200">${totalItems}</span> | 
                        Собрано: <span class="font-semibold text-green-400">${collectedCount}</span>
                    </div>
                    <div class="text-[9px] md:text-xs text-slate-500 hidden md:block">
                        Прокрутите для просмотра всех товаров
                    </div>
                </div>
                <div class="overflow-y-auto max-h-[calc(100vh-240px)] md:max-h-[60vh] border border-slate-700 rounded-lg -mx-1 md:mx-0">
                    <table class="w-full border-collapse">
                        <thead class="bg-slate-800 sticky top-0 z-10 hidden md:table-header-group">
                            <tr>
                                <th class="px-1 md:px-1 py-1 md:py-2 text-center text-[8px] md:text-xs font-semibold text-slate-300 uppercase border-b border-slate-700 w-8 md:w-10">Статус</th>
                                <th class="px-1 md:px-2 py-1 md:py-2 text-left text-[8px] md:text-xs font-semibold text-slate-300 uppercase border-b border-slate-700 min-w-0 name-header-col hidden md:table-cell" style="max-width: 200px;">Наименование</th>
                                <th class="px-1 md:px-2 py-1 md:py-2 text-left text-[8px] md:text-xs font-semibold text-slate-300 uppercase border-b border-slate-700 hidden md:table-cell w-20">Артикул</th>
                                <th class="px-1 md:px-2 py-1 md:py-2 text-left text-[8px] md:text-xs font-semibold text-slate-300 uppercase border-b border-slate-700 hidden md:table-cell w-20">Место</th>
                                <th class="px-1 md:px-2 py-1 md:py-2 text-center text-[8px] md:text-xs font-semibold text-slate-300 uppercase border-b border-slate-700 w-12 md:w-16 hidden md:table-cell">Требуется</th>
                                <th class="px-1 md:px-2 py-1 md:py-2 text-center text-[8px] md:text-xs font-semibold text-slate-300 uppercase border-b border-slate-700 w-16 md:w-20 hidden md:table-cell">Собрано</th>
                                <th class="px-1 md:px-2 py-1 md:py-2 text-center text-[8px] md:text-xs font-semibold text-slate-300 uppercase border-b border-slate-700 w-20 md:w-32 hidden md:table-cell">Действия</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y-0 md:divide-y divide-slate-800">
                            ${sortedIndices.map((originalIndex) => {
                                const line = currentPrintShipment.lines[originalIndex];
                                const index = originalIndex; // Сохраняем оригинальный индекс для работы с состоянием
                                const state = collectChecklistState[index] || { collected: false, qty: line.qty, collectedQty: line.qty };
                                const isCollected = state.collected;
                                const hasShortage = state.collectedQty < line.qty && state.collectedQty > 0; // Недостача независимо от статуса собранности
                                const isZero = state.collectedQty === 0 && isCollected;
                                const isFull = state.collectedQty === line.qty && isCollected;
                                
                                // Определяем цвет фона строки
                                let rowBg = 'bg-slate-900';
                                if (isCollected) {
                                    if (isZero) {
                                        rowBg = 'bg-red-900/20';
                                    } else {
                                        // Для всех собранных товаров (кроме нулевых) - зеленоватый фон
                                        rowBg = 'bg-green-900/20';
                                    }
                                }
                                
                                return `
                                    <!-- Мобильная версия: компактная карточка товара -->
                                    <tr class="md:hidden">
                                        <td colspan="7" class="p-0 w-full">
                                            <div class="${rowBg} border-b border-slate-700/50 mb-1.5 rounded overflow-hidden w-full">
                                                <!-- Первая строка: наименование и основная информация -->
                                                <div class="px-2 py-1.5 flex items-start justify-between gap-2">
                                                    <div class="flex-1 min-w-0">
                                                        <div class="name-tooltip font-medium text-xs leading-tight ${hasShortage ? 'text-orange-400' : 'text-slate-100'} mb-0.5 line-clamp-2 cursor-pointer hover:opacity-80 transition-opacity active:scale-95" 
                                                             onclick="showNameTooltip(event, '${escapeHtml(line.name).replace(/'/g, "\\'")}', '${escapeHtml(line.sku || '').replace(/'/g, "\\'")}', '${escapeHtml(line.location || '').replace(/'/g, "\\'")}', ${line.qty}, ${state.collectedQty || 0})">
                                                            ${escapeHtml(line.name)}
                                                        </div>
                                                        <div class="flex items-center gap-2 text-[9px] text-slate-500">
                                                            <span>${escapeHtml(line.sku)}</span>
                                                            ${line.location ? `<span class="text-blue-400">${escapeHtml(line.location)}</span>` : ''}
                                                        </div>
                                                    </div>
                                                    <div class="flex items-center gap-1.5 flex-shrink-0">
                                                        <div class="text-right">
                                                            <div class="text-[9px] text-slate-500">Треб</div>
                                                            <div class="text-sm font-semibold text-slate-200">${line.qty}</div>
                                                        </div>
                                                        <div class="text-right">
                                                            <div class="text-[9px] text-slate-500">Собр</div>
                                                            ${collectEditState[index] ? `
                                                                <div class="flex items-center gap-0.5">
                                                                    <button onclick="adjustQty(${index}, -1)" 
                                                                            class="w-5 h-5 bg-slate-700 hover:bg-slate-600 text-slate-100 rounded transition-colors flex items-center justify-center text-[10px] font-bold touch-manipulation"
                                                                            ${state.collectedQty <= 0 ? 'opacity-50 cursor-not-allowed' : ''}>
                                                                        −
                                                                    </button>
                                                                    <input type="number" 
                                                                           id="qty-input-mobile-${index}"
                                                                           min="0" 
                                                                           max="${line.qty}"
                                                                           value="${state.collectedQty}"
                                                                           step="1"
                                                                           inputmode="numeric"
                                                                           pattern="[0-9]*"
                                                                           class="w-10 bg-slate-800 border border-slate-600 text-slate-100 rounded px-0.5 py-0.5 text-center text-[10px] font-semibold focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                                           onchange="updateCollectedQty(${index}, parseInt(this.value) || 0)"
                                                                           oninput="handleQtyInput(${index}, this)"
                                                                           onkeydown="handleQtyKeydown(event, ${index}, ${line.qty})">
                                                                    <button onclick="adjustQty(${index}, 1)" 
                                                                            class="w-5 h-5 bg-slate-700 hover:bg-slate-600 text-slate-100 rounded transition-colors flex items-center justify-center text-[10px] font-bold touch-manipulation"
                                                                            ${state.collectedQty >= line.qty ? 'opacity-50 cursor-not-allowed' : ''}>
                                                                        +
                                                                    </button>
                                                                </div>
                                                            ` : `
                                                                <div class="text-sm font-semibold ${hasShortage ? 'text-orange-400' : 'text-slate-200'}">${state.collectedQty}</div>
                                                            `}
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- Вторая строка: действия и статусы -->
                                                <div class="px-2 py-1 border-t border-slate-700/30">
                                                    ${collectEditState[index] ? `
                                                        <div class="flex gap-1.5 w-full">
                                                            <button onclick="confirmEditQty(${index})" 
                                                                    class="flex-1 px-2 py-1 bg-green-600 hover:bg-green-700 text-white text-[10px] font-semibold rounded transition-colors flex items-center justify-center gap-1 touch-manipulation">
                                                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                                </svg>
                                                                Подтвердить
                                                            </button>
                                                            <button onclick="cancelEditQty(${index})" 
                                                                    class="px-2 py-1 bg-slate-700 hover:bg-slate-600 text-slate-200 text-[10px] font-medium rounded transition-colors touch-manipulation">
                                                                Отмена
                                                            </button>
                                                        </div>
                                                    ` : `
                                                        <div class="flex gap-1.5 w-full items-center">
                                                            ${isCollected ? `
                                                                <button onclick="startEditQty(${index})" 
                                                                        class="px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white text-[10px] font-medium rounded transition-colors flex items-center justify-center gap-1 touch-manipulation">
                                                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                                                    </svg>
                                                                    Ред.
                                                                </button>
                                                            ` : `
                                                                <button onclick="startEditQty(${index})" 
                                                                        class="px-1.5 py-1 bg-blue-600 hover:bg-blue-700 text-white text-[9px] font-medium rounded transition-colors flex items-center justify-center touch-manipulation">
                                                                    Ред.
                                                                </button>
                                                                <!-- Swipe-to-collect для мобильных - выровнен справа -->
                                                                <div class="ml-auto relative overflow-hidden rounded-lg" style="max-width: 50%; min-width: 120px;">
                                                                    <div id="swipe-collect-track-${index}" class="relative w-full h-10 bg-slate-700 rounded-lg overflow-hidden border-2 border-slate-600" style="touch-action: pan-x; cursor: grab; user-select: none; -webkit-user-select: none;">
                                                                        <div id="swipe-collect-slider-${index}" class="absolute left-0 top-0 h-full bg-green-600 flex items-center justify-center transition-none z-20" style="width: 50px; min-width: 50px;">
                                                                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3">
                                                                                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path>
                                                                            </svg>
                                                                        </div>
                                                                        <div id="swipe-collect-text-${index}" class="absolute inset-0 flex items-center justify-center text-slate-200 font-bold text-[10px] pointer-events-none z-10 px-2" style="left: 50px;">
                                                                            <span>→ Сдвиньте</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            `}
                                                        </div>
                                                    `}
                                                    ${isCollected && isZero ? `
                                                        <div class="text-[9px] text-red-400 font-semibold mt-1">⚠ Не собрано</div>
                                                    ` : isCollected && hasShortage ? `
                                                        <div class="text-[9px] text-yellow-500 mt-1">⚠ Недостаток: ${line.qty - state.collectedQty}</div>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    <!-- Десктоп версия: обычная таблица -->
                                    <tr class="hidden md:table-row ${rowBg} hover:bg-slate-800 transition-colors ${isCollected ? 'opacity-90' : ''}">
                                        <td class="px-1 md:px-1 py-1 md:py-2 border-b border-slate-800 w-8 md:w-10 text-center">
                                            ${isCollected ? `
                                                ${isZero ? `
                                                    <div class="flex items-center justify-center w-4 h-4 md:w-6 md:h-6 bg-red-600 rounded-full mx-auto">
                                                        <svg class="w-2.5 h-2.5 md:w-4 md:h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                        </svg>
                                                    </div>
                                                ` : `
                                                    <div class="flex items-center justify-center w-4 h-4 md:w-6 md:h-6 bg-green-600 rounded-full mx-auto">
                                                        <svg class="w-2.5 h-2.5 md:w-4 md:h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                        </svg>
                                                    </div>
                                                `}
                                            ` : `
                                                <div class="w-1 h-1 md:w-1.5 md:h-1.5 bg-slate-600 rounded-full mx-auto"></div>
                                            `}
                                        </td>
                                        <td class="px-1 md:px-2 py-1 md:py-2 border-b border-slate-800 min-w-0 hidden md:table-cell" style="max-width: 200px;">
                                            <div class="name-tooltip font-medium text-[10px] md:text-xs leading-tight line-clamp-2 ${hasShortage ? 'text-orange-400 md:text-slate-100' : 'text-slate-100'} cursor-pointer hover:opacity-80 transition-opacity active:scale-95" 
                                                 onclick="showNameTooltip(event, '${escapeHtml(line.name).replace(/'/g, "\\'")}', '${escapeHtml(line.sku || '').replace(/'/g, "\\'")}', '${escapeHtml(line.location || '').replace(/'/g, "\\'")}', ${line.qty}, ${state.collectedQty || 0})">
                                                ${escapeHtml(line.name)}
                                            </div>
                                            ${isCollected && isZero ? `
                                                <div class="text-[8px] md:text-[10px] text-red-400 font-semibold mt-0.5">Не собрано</div>
                                            ` : isCollected && hasShortage ? `
                                                <div class="text-[8px] md:text-[10px] text-yellow-500 mt-0.5">Недостаток: ${line.qty - state.collectedQty}</div>
                                            ` : ''}
                                        </td>
                                        <!-- Десктоп: отдельные ячейки -->
                                        <td class="px-1 md:px-2 py-1 md:py-2 border-b border-slate-800 hidden md:table-cell w-20">
                                            <div class="text-xs text-slate-400 truncate">${escapeHtml(line.sku)}</div>
                                        </td>
                                        <td class="px-1 md:px-2 py-1 md:py-2 border-b border-slate-800 hidden md:table-cell w-20">
                                            <div class="text-xs text-slate-400 line-clamp-2 leading-tight">${line.location ? escapeHtml(line.location) : '—'}</div>
                                        </td>
                                        <td class="px-1 md:px-2 py-1 md:py-2 text-center border-b border-slate-800 hidden md:table-cell w-16">
                                            <div class="text-sm font-semibold text-slate-200">${line.qty}</div>
                                            <div class="text-[10px] text-slate-500">${escapeHtml(line.uom)}</div>
                                        </td>
                                        <td class="px-1 md:px-2 py-1 md:py-2 text-center border-b border-slate-800 hidden md:table-cell w-20">
                                            ${collectEditState[index] ? `
                                                <div class="flex items-center justify-center gap-0.5 md:gap-1 flex-col md:flex-row">
                                                    <div class="flex items-center justify-center gap-0.5 md:gap-1">
                                                        <button onclick="adjustQty(${index}, -1)" 
                                                                class="w-3.5 h-3.5 md:w-5 md:h-5 bg-slate-700 hover:bg-slate-600 text-slate-100 rounded transition-colors flex items-center justify-center text-[9px] md:text-xs font-bold touch-manipulation"
                                                                ${state.collectedQty <= 0 ? 'opacity-50 cursor-not-allowed' : ''}>
                                                            −
                                                        </button>
                                                        <input type="number" 
                                                               id="qty-input-${index}"
                                                               min="0" 
                                                               max="${line.qty}"
                                                               value="${state.collectedQty}"
                                                               step="1"
                                                               inputmode="numeric"
                                                               pattern="[0-9]*"
                                                               class="w-10 md:w-12 bg-slate-800 border border-slate-600 text-slate-100 rounded px-0.5 md:px-1 py-0.5 text-center text-[9px] md:text-xs font-semibold focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                               onchange="updateCollectedQty(${index}, parseInt(this.value) || 0)"
                                                               oninput="handleQtyInput(${index}, this)"
                                                               onkeydown="handleQtyKeydown(event, ${index}, ${line.qty})">
                                                        <button onclick="adjustQty(${index}, 1)" 
                                                                class="w-3.5 h-3.5 md:w-5 md:h-5 bg-slate-700 hover:bg-slate-600 text-slate-100 rounded transition-colors flex items-center justify-center text-[9px] md:text-xs font-bold touch-manipulation"
                                                                ${state.collectedQty >= line.qty ? 'opacity-50 cursor-not-allowed' : ''}>
                                                            +
                                                        </button>
                                                    </div>
                                                    <button onclick="setFullQty(${index}, ${line.qty})" 
                                                            class="text-[7px] md:text-[10px] text-blue-400 hover:text-blue-300 transition-colors touch-manipulation">
                                                        Макс
                                                    </button>
                                                </div>
                                            ` : `
                                                <div class="text-[10px] md:text-xs font-semibold text-slate-200 leading-tight">
                                                    ${state.collectedQty}
                                                </div>
                                                <div class="text-[8px] md:text-[10px] text-slate-500">${escapeHtml(line.uom)}</div>
                                            `}
                                        </td>
                                        <td class="px-1 md:px-1.5 py-1 md:py-2 text-center border-b border-slate-800 w-20 md:w-28">
                                            ${collectEditState[index] ? `
                                                <div class="flex gap-0.5 md:gap-0.5 justify-center items-center flex-wrap">
                                                    <button onclick="confirmEditQty(${index})" 
                                                            class="px-1 py-0.5 md:px-1.5 md:py-1 bg-green-600 hover:bg-green-700 text-white text-[7px] md:text-[9px] font-semibold rounded transition-colors flex items-center justify-center touch-manipulation whitespace-nowrap">
                                                        ✓
                                                    </button>
                                                    <button onclick="cancelEditQty(${index})" 
                                                            class="px-1 py-0.5 md:px-1.5 md:py-1 bg-slate-700 hover:bg-slate-600 text-slate-200 text-[7px] md:text-[9px] font-medium rounded transition-colors touch-manipulation whitespace-nowrap">
                                                        Отмена
                                                    </button>
                                                </div>
                                            ` : isCollected ? `
                                                <div class="flex gap-0.5 md:gap-0.5 items-center justify-center">
                                                    <button onclick="startEditQty(${index})" 
                                                            class="px-1 py-0.5 md:px-1.5 md:py-1 bg-blue-600 hover:bg-blue-700 text-white text-[6px] md:text-[9px] font-medium rounded transition-colors flex items-center justify-center touch-manipulation whitespace-nowrap">
                                                        Ред.
                                                    </button>
                                                </div>
                                            ` : `
                                                <div class="flex gap-0.5 md:gap-0.5 items-center justify-center">
                                                    <button onclick="startEditQty(${index})" 
                                                            class="px-1 py-0.5 md:px-1.5 md:py-1 bg-blue-600 hover:bg-blue-700 text-white text-[6px] md:text-[9px] font-medium rounded transition-colors flex items-center justify-center touch-manipulation whitespace-nowrap flex-shrink-0">
                                                        Ред.
                                                    </button>
                                                    <button onclick="toggleCollected(${index})" 
                                                            class="px-1.5 py-1 md:px-3 md:py-1.5 bg-green-600 hover:bg-green-700 text-white text-[9px] md:text-[10px] font-bold rounded transition-colors flex items-center justify-center shadow-md touch-manipulation whitespace-nowrap">
                                                        Собрано
                                                    </button>
                                                </div>
                                            `}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            // Восстанавливаем позицию скролла после перерисовки
            // Используем requestAnimationFrame для гарантии, что DOM обновлен
            requestAnimationFrame(() => {
                const scrollContainer = document.querySelector('#collect-modal .overflow-y-auto');
                if (scrollContainer) {
                    scrollContainer.scrollTop = savedScrollTop;
                } else {
                    // Если контейнер еще не найден, пробуем через небольшую задержку
                    setTimeout(() => {
                        const delayedScrollContainer = document.querySelector('#collect-modal .overflow-y-auto');
                        if (delayedScrollContainer) {
                            delayedScrollContainer.scrollTop = savedScrollTop;
                        }
                    }, 10);
                }
            });
        }


        // Обработка ввода количества с клавиатуры
        function handleQtyInput(lineIndex, inputElement) {
            let value = inputElement.value;
            // Удаляем все нецифровые символы
            value = value.replace(/[^0-9]/g, '');
            if (value === '') value = '0';
            
            const numValue = parseInt(value) || 0;
            const line = currentPrintShipment.lines[lineIndex];
            const maxQty = line.qty;
            
            // Ограничиваем максимальным количеством
            if (numValue > maxQty) {
                inputElement.value = maxQty;
                updateCollectedQty(lineIndex, maxQty);
            } else {
                inputElement.value = numValue;
                updateCollectedQty(lineIndex, numValue);
            }
        }

        // Обработка клавиш для поля количества
        function handleQtyKeydown(event, lineIndex, maxQty) {
            // Разрешаем: цифры, Backspace, Delete, Tab, стрелки
            const allowedKeys = ['Backspace', 'Delete', 'Tab', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'];
            
            if (allowedKeys.includes(event.key)) {
                // Для стрелок вверх/вниз изменяем количество
                if (event.key === 'ArrowUp') {
                    event.preventDefault();
                    adjustQty(lineIndex, 1);
                } else if (event.key === 'ArrowDown') {
                    event.preventDefault();
                    adjustQty(lineIndex, -1);
                }
                return;
            }
            
            // Разрешаем только цифры
            if (!/[0-9]/.test(event.key) && !event.ctrlKey && !event.metaKey) {
                event.preventDefault();
            }
        }

        // Изменение количества на указанное значение
        function adjustQty(lineIndex, delta) {
            if (!collectChecklistState[lineIndex]) {
                const line = currentPrintShipment.lines[lineIndex];
                collectChecklistState[lineIndex] = { collected: false, qty: line.qty, collectedQty: line.qty };
            }

            const line = currentPrintShipment.lines[lineIndex];
            const currentQty = collectChecklistState[lineIndex].collectedQty;
            const newQty = Math.max(0, Math.min(line.qty, currentQty + delta));
            
            updateCollectedQty(lineIndex, newQty);
        }

        // Установка максимального количества
        function setFullQty(lineIndex, maxQty) {
            updateCollectedQty(lineIndex, maxQty);
        }

        // Переключение статуса собранности
        function toggleCollected(lineIndex) {
            if (!collectChecklistState[lineIndex]) {
                const line = currentPrintShipment.lines[lineIndex];
                collectChecklistState[lineIndex] = { collected: false, qty: line.qty, collectedQty: line.qty };
            }

            const state = collectChecklistState[lineIndex];
            // Если товар еще не собран, сразу подтверждаем без вопросов
            if (!state.collected) {
                // Разрешаем сборку даже с количеством 0
                updateCollectChecklist(lineIndex, 'collected', true);
            } else {
                // Если уже собран, отменяем
                updateCollectChecklist(lineIndex, 'collected', false);
            }
        }

        // Обновление собранного количества
        function updateCollectedQty(lineIndex, qty) {
            if (!collectChecklistState[lineIndex]) {
                const line = currentPrintShipment.lines[lineIndex];
                collectChecklistState[lineIndex] = { collected: false, qty: line.qty, collectedQty: line.qty };
            }

            const line = currentPrintShipment.lines[lineIndex];
            // Ограничиваем максимальным количеством и делаем целое число
            const maxQty = line.qty;
            const newQty = Math.min(Math.max(0, Math.floor(qty)), maxQty);
            
            collectChecklistState[lineIndex].collectedQty = newQty;

            // Обновляем значение в поле ввода
            const qtyInput = document.getElementById(`qty-input-${lineIndex}`);
            if (qtyInput) {
                qtyInput.value = newQty;
            }

            // Не снимаем отметку "Собран" при количестве 0 - разрешаем собирать с 0

            renderCollectChecklist();
            updateCollectProgress();
            
            // Переинициализируем swipe-to-collect после изменения состояния
            setTimeout(() => {
                initSwipeToCollect();
            }, 200);
        }

        // Обновление состояния чеклиста
        function updateCollectChecklist(lineIndex, step, checked) {
            if (!collectChecklistState[lineIndex]) {
                const line = currentPrintShipment.lines[lineIndex];
                collectChecklistState[lineIndex] = { 
                    collected: false, 
                    qty: line.qty, 
                    collectedQty: line.qty 
                };
            }
            
            // Обрабатываем только шаг "collected"
            if (step === 'collected') {
                collectChecklistState[lineIndex].collected = checked;
                
                // Сбрасываем состояние swipe для этого элемента
                if (swipeCollectState[lineIndex]) {
                    swipeCollectState[lineIndex].hasCollected = checked;
                    swipeCollectState[lineIndex].isDragging = false;
                }
            }

            renderCollectChecklist();
            updateCollectProgress();
            
            // Переинициализируем swipe-to-collect после изменения состояния
            setTimeout(() => {
                initSwipeToCollect();
            }, 200);
        }

        // Обновление прогресса сборки
        function updateCollectProgress() {
            if (!currentPrintShipment || !currentPrintShipment.lines) return;

            const total = currentPrintShipment.lines.length;
            let collectedCount = 0;
            let hasShortage = false;

            currentPrintShipment.lines.forEach((_, index) => {
                if (collectChecklistState[index]) {
                    if (collectChecklistState[index].collected) collectedCount++;
                    // Проверяем недостаток
                    if (collectChecklistState[index].collectedQty < collectChecklistState[index].qty) {
                        hasShortage = true;
                    }
                }
            });

            const progressEl = document.getElementById('collect-progress');
            const statusEl = document.getElementById('collect-status');
            const confirmBtn = document.getElementById('confirm-collect-btn');
            const swipeContainer = document.getElementById('swipe-confirm-container');
            const swipeSlider = document.getElementById('swipe-confirm-slider');
            const swipeText = document.getElementById('swipe-confirm-text');

            progressEl.textContent = `${collectedCount}/${total}`;

            const isReady = collectedCount === total && total > 0;
            
            if (isReady) {
                if (hasShortage) {
                    statusEl.innerHTML = '<span class="text-yellow-500 font-semibold">⚠ Все товары обработаны (есть недостачи)</span>';
                } else {
                    statusEl.innerHTML = '<span class="text-green-500 font-semibold">✓ Все товары собраны полностью</span>';
                }
                if (confirmBtn) confirmBtn.disabled = false;
                // Включаем swipe на мобильных
                if (swipeContainer) {
                    swipeContainer.style.pointerEvents = 'auto';
                    swipeContainer.style.opacity = '1';
                }
            } else {
                statusEl.innerHTML = '<span class="text-slate-400">Укажите количество и отметьте собранные товары</span>';
                if (confirmBtn) confirmBtn.disabled = true;
                // Отключаем swipe на мобильных
                if (swipeContainer) {
                    swipeContainer.style.pointerEvents = 'none';
                    swipeContainer.style.opacity = '0.5';
                }
                // Сбрасываем позицию слайдера
                if (swipeSlider) swipeSlider.style.width = '0%';
            }
        }

        // Инициализация swipe-to-collect для каждого товара
        let swipeCollectHandlers = {};
        let swipeCollectState = {}; // Отдельное состояние для каждого элемента
        
        function initSwipeToCollect() {
            if (!currentPrintShipment || !currentPrintShipment.lines) return;
            
            // Небольшая задержка для гарантии, что DOM обновлен
            setTimeout(() => {
                currentPrintShipment.lines.forEach((line, index) => {
                    const track = document.getElementById(`swipe-collect-track-${index}`);
                    const slider = document.getElementById(`swipe-collect-slider-${index}`);
                    const text = document.getElementById(`swipe-collect-text-${index}`);
                    
                    if (!track || !slider || !text) {
                        return;
                    }
                    
                    // Удаляем старые обработчики, если они есть
                    if (swipeCollectHandlers[index]) {
                        const oldHandlers = swipeCollectHandlers[index];
                        track.removeEventListener('touchstart', oldHandlers.handleStart);
                        track.removeEventListener('touchmove', oldHandlers.handleMove);
                        track.removeEventListener('touchend', oldHandlers.handleEnd);
                        track.removeEventListener('touchcancel', oldHandlers.handleEnd);
                        track.removeEventListener('mousedown', oldHandlers.handleStart);
                        if (oldHandlers.mouseMoveHandler) {
                            document.removeEventListener('mousemove', oldHandlers.mouseMoveHandler);
                        }
                        if (oldHandlers.mouseUpHandler) {
                            document.removeEventListener('mouseup', oldHandlers.mouseUpHandler);
                        }
                    }
                    
                    const state = collectChecklistState[index];
                    if (state && state.collected) {
                        // Если товар уже собран, показываем как собранный
                        slider.style.width = '100%';
                        slider.style.transition = 'width 0.3s ease-out';
                        text.textContent = '✓ Собрано';
                        text.style.color = 'white';
                        text.style.left = '0';
                        track.parentElement.classList.add('completed-collect');
                        // Инициализируем состояние как собранное
                        swipeCollectState[index] = {
                            isDragging: false,
                            hasCollected: true,
                            startX: 0,
                            currentX: 0
                        };
                        return;
                    }
                    
                    // Инициализируем состояние для каждого элемента отдельно
                    // ВАЖНО: всегда сбрасываем состояние, даже если оно уже было
                    swipeCollectState[index] = {
                        isDragging: false,
                        hasCollected: false,
                        startX: 0,
                        currentX: 0
                    };
                    
                    // Сбрасываем состояние для несобранных товаров
                    slider.style.width = '50px';
                    slider.style.transition = 'none';
                    text.textContent = '→ Сдвиньте';
                    text.style.color = '';
                    text.style.left = '50px';
                    track.parentElement.classList.remove('completed-collect', 'swiping-collect');
                    
                    // Убеждаемся, что track доступен для взаимодействия
                    track.style.pointerEvents = 'auto';
                    track.style.cursor = 'grab';
                    track.style.opacity = '1';
                    
                    const sliderMinWidth = 50;
                    const threshold = 0.75;
                    
                    const updateSlider = () => {
                        const trackWidth = track.offsetWidth;
                        const maxWidth = trackWidth - sliderMinWidth;
                        const deltaX = swipeCollectState[index].currentX - swipeCollectState[index].startX;
                        const newWidth = Math.min(Math.max(sliderMinWidth + deltaX, sliderMinWidth), trackWidth);
                        
                        slider.style.width = `${newWidth}px`;
                        
                        const percentage = maxWidth > 0 ? (newWidth - sliderMinWidth) / maxWidth : 0;
                        
                        // Обновляем позицию текста
                        if (newWidth < trackWidth) {
                            text.style.left = `${newWidth}px`;
                        } else {
                            text.style.left = '0';
                        }
                        
                        if (percentage >= threshold && !swipeCollectState[index].hasCollected) {
                            // Предотвращаем повторное срабатывание
                            if (swipeCollectState[index].hasCollected) return;
                            
                            swipeCollectState[index].hasCollected = true;
                            swipeCollectState[index].isDragging = false;
                            track.parentElement.classList.add('completed-collect');
                            text.textContent = '✓ Собрано';
                            text.style.color = 'white';
                            text.style.left = '0';
                            slider.style.width = '100%';
                            track.style.cursor = 'grab';
                            track.parentElement.classList.remove('swiping-collect');
                            
                            // Автоматически подтверждаем сборку
                            setTimeout(() => {
                                // Проверяем, что состояние еще актуально
                                if (swipeCollectState[index] && swipeCollectState[index].hasCollected) {
                                    toggleCollected(index);
                                }
                            }, 150);
                        } else if (percentage < threshold && swipeCollectState[index].hasCollected) {
                            swipeCollectState[index].hasCollected = false;
                            track.parentElement.classList.remove('completed-collect');
                            text.textContent = '→ Сдвиньте';
                            text.style.color = '';
                        }
                    };
                    
                    const handleStart = (e) => {
                        // Проверяем состояние товара перед началом свайпа
                        const currentState = collectChecklistState[index];
                        if (currentState && currentState.collected) {
                            return; // Товар уже собран
                        }
                        if (swipeCollectState[index].hasCollected) {
                            return; // Уже в процессе подтверждения
                        }
                        
                        const touch = e.touches ? e.touches[0] : e;
                        const trackRect = track.getBoundingClientRect();
                        swipeCollectState[index].startX = touch.clientX - trackRect.left;
                        swipeCollectState[index].currentX = swipeCollectState[index].startX;
                        swipeCollectState[index].isDragging = true;
                        slider.style.transition = 'none';
                        track.style.cursor = 'grabbing';
                        track.parentElement.classList.add('swiping-collect');
                        e.preventDefault();
                        e.stopPropagation();
                    };
                    
                    const handleMove = (e) => {
                        // Проверяем состояние перед движением
                        if (!swipeCollectState[index] || !swipeCollectState[index].isDragging) return;
                        if (swipeCollectState[index].hasCollected) return;
                        
                        const currentState = collectChecklistState[index];
                        if (currentState && currentState.collected) {
                            return; // Товар уже собран
                        }
                        
                        const touch = e.touches ? e.touches[0] : e;
                        const trackRect = track.getBoundingClientRect();
                        swipeCollectState[index].currentX = touch.clientX - trackRect.left;
                        updateSlider();
                        e.preventDefault();
                        e.stopPropagation();
                    };
                    
                    const handleEnd = () => {
                        if (!swipeCollectState[index] || !swipeCollectState[index].isDragging) return;
                        swipeCollectState[index].isDragging = false;
                        track.style.cursor = 'grab';
                        slider.style.transition = 'width 0.3s ease-out';
                        track.parentElement.classList.remove('swiping-collect');
                        
                        if (!swipeCollectState[index].hasCollected) {
                            // Возвращаем слайдер в исходное положение
                            slider.style.width = '50px';
                            text.style.left = '50px';
                            // Сбрасываем координаты
                            swipeCollectState[index].startX = 0;
                            swipeCollectState[index].currentX = 0;
                        }
                    };
                    
                    // Сохраняем обработчики
                    const handlers = { handleStart, handleMove, handleEnd };
                    swipeCollectHandlers[index] = handlers;
                    
                    // Touch события
                    track.addEventListener('touchstart', handleStart, { passive: false });
                    track.addEventListener('touchmove', handleMove, { passive: false });
                    track.addEventListener('touchend', handleEnd, { passive: true });
                    track.addEventListener('touchcancel', handleEnd, { passive: true });
                    
                    // Mouse события (для тестирования на десктопе)
                    track.addEventListener('mousedown', handleStart);
                    const mouseMoveHandler = (e) => {
                        if (swipeCollectState[index].isDragging) handleMove(e);
                    };
                    const mouseUpHandler = () => {
                        if (swipeCollectState[index].isDragging) handleEnd();
                    };
                    document.addEventListener('mousemove', mouseMoveHandler);
                    document.addEventListener('mouseup', mouseUpHandler);
                    
                    handlers.mouseMoveHandler = mouseMoveHandler;
                    handlers.mouseUpHandler = mouseUpHandler;
                });
            }, 100);
        }
        
        // Инициализация swipe-to-confirm
        let swipeHandlers = null;
        function initSwipeToConfirm() {
            const container = document.getElementById('swipe-confirm-container');
            const track = document.getElementById('swipe-confirm-track');
            const slider = document.getElementById('swipe-confirm-slider');
            const text = document.getElementById('swipe-confirm-text');
            
            if (!container || !track || !slider || !text) return;
            
            // Удаляем старые обработчики, если они есть
            if (swipeHandlers) {
                track.removeEventListener('touchstart', swipeHandlers.handleStart);
                track.removeEventListener('touchmove', swipeHandlers.handleMove);
                track.removeEventListener('touchend', swipeHandlers.handleEnd);
                track.removeEventListener('touchcancel', swipeHandlers.handleEnd);
                track.removeEventListener('mousedown', swipeHandlers.handleStart);
                document.removeEventListener('mousemove', swipeHandlers.handleMove);
                document.removeEventListener('mouseup', swipeHandlers.handleEnd);
            }
            
            let startX = 0;
            let currentX = 0;
            let isDragging = false;
            let hasConfirmed = false;
            const threshold = 0.85; // 85% для подтверждения
            
            const updateSlider = () => {
                const trackWidth = track.offsetWidth;
                const sliderWidth = trackWidth * 0.15; // Минимальная ширина слайдера
                const maxWidth = trackWidth - sliderWidth;
                const percentage = Math.min(Math.max((currentX - startX) / maxWidth, 0), 1);
                
                slider.style.width = `${sliderWidth + percentage * maxWidth}px`;
                
                if (percentage >= threshold && !hasConfirmed) {
                    hasConfirmed = true;
                    container.classList.add('completed');
                    text.textContent = '✓ Подтверждено';
                    text.style.color = 'white';
                    // Автоматически подтверждаем через небольшую задержку
                    setTimeout(() => {
                        confirmProcessing();
                    }, 300);
                } else if (percentage < threshold && hasConfirmed) {
                    hasConfirmed = false;
                    container.classList.remove('completed');
                    text.textContent = 'Сдвиньте вправо для подтверждения →';
                    text.style.color = '';
                }
            };
            
            const handleStart = (e) => {
                if (hasConfirmed) return;
                const touch = e.touches ? e.touches[0] : e;
                startX = touch.clientX;
                currentX = startX;
                isDragging = true;
                container.classList.add('swiping');
                e.preventDefault();
            };
            
            const handleMove = (e) => {
                if (!isDragging || hasConfirmed) return;
                const touch = e.touches ? e.touches[0] : e;
                currentX = touch.clientX;
                updateSlider();
                e.preventDefault();
            };
            
            const handleEnd = () => {
                if (!isDragging) return;
                isDragging = false;
                container.classList.remove('swiping');
                
                if (!hasConfirmed) {
                    // Возвращаем слайдер в исходное положение
                    slider.style.width = '0%';
                }
            };
            
            // Сохраняем обработчики для последующего удаления
            swipeHandlers = { handleStart, handleMove, handleEnd };
            
            // Touch события
            track.addEventListener('touchstart', handleStart, { passive: false });
            track.addEventListener('touchmove', handleMove, { passive: false });
            track.addEventListener('touchend', handleEnd);
            track.addEventListener('touchcancel', handleEnd);
            
            // Mouse события (для тестирования на десктопе)
            track.addEventListener('mousedown', handleStart);
            const mouseMoveHandler = (e) => {
                if (isDragging) handleMove(e);
            };
            document.addEventListener('mousemove', mouseMoveHandler);
            document.addEventListener('mouseup', handleEnd);
            
            // Сохраняем mouseMoveHandler для удаления
            swipeHandlers.mouseMoveHandler = mouseMoveHandler;
        }
        
        // Закрытие модального окна сборки
        async function closeCollectModal() {
            // Разблокируем скролл body
            document.body.style.overflow = '';
            document.body.style.position = '';
            document.body.style.width = '';
            // Разблокируем заказ, если он был заблокирован
            if (lockedShipmentId) {
                try {
                    await fetch(API_ENDPOINTS.unlock(lockedShipmentId), {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ userId: USER_ID })
                    });
                    lockedShipmentId = null;
                    // Обновляем список заказов
                    loadShipments();
                } catch (error) {
                    console.error('Ошибка разблокировки:', error);
                }
            }

            document.getElementById('collect-modal').classList.add('hidden');
            currentPrintShipment = null;
            collectChecklistState = {};
            collectEditState = {};
            
            // Сбрасываем swipe состояние
            const swipeContainer = document.getElementById('swipe-confirm-container');
            const swipeSlider = document.getElementById('swipe-confirm-slider');
            const swipeText = document.getElementById('swipe-confirm-text');
            if (swipeContainer) {
                swipeContainer.classList.remove('swiping', 'completed');
                swipeContainer.style.pointerEvents = '';
                swipeContainer.style.opacity = '';
            }
            if (swipeSlider) {
                swipeSlider.style.width = '0%';
            }
            if (swipeText) {
                swipeText.textContent = 'Сдвиньте вправо для подтверждения →';
                swipeText.style.color = '';
            }
        }

        // Начало редактирования количества
        function startEditQty(lineIndex) {
            const state = collectChecklistState[lineIndex];
            if (state) {
                // Сохраняем исходное значение для возможности отмены
                state.originalQty = state.collectedQty;
            }
            collectEditState[lineIndex] = true;
            renderCollectChecklist();
        }

        // Подтверждение редактирования количества
        function confirmEditQty(lineIndex) {
            collectEditState[lineIndex] = false;
            renderCollectChecklist();
            updateCollectProgress();
            
            // Переинициализируем swipe-to-collect
            setTimeout(() => {
                initSwipeToCollect();
            }, 150);
        }

        // Отмена редактирования количества
        function cancelEditQty(lineIndex) {
            if (!currentPrintShipment || !currentPrintShipment.lines) return;
            const line = currentPrintShipment.lines[lineIndex];
            const state = collectChecklistState[lineIndex];
            
            // Восстанавливаем исходное значение
            if (state && state.originalQty !== undefined) {
                state.collectedQty = state.originalQty;
            } else {
                state.collectedQty = line.qty;
            }
            
            collectEditState[lineIndex] = false;
            renderCollectChecklist();
        }

        // Начало редактирования количества в деталях
        function startDetailsEditQty(lineIndex) {
            if (!currentPrintShipment || !currentPrintShipment.lines) return;
            const line = currentPrintShipment.lines[lineIndex];
            if (line) {
                // Сохраняем исходное значение
                line.originalQty = line.collected_qty !== undefined ? line.collected_qty : line.qty;
            }
            detailsEditState[lineIndex] = true;
            renderDetailsChecklist(currentPrintShipment, new Date(currentPrintShipment.created_at).toLocaleString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }));
        }

        // Подтверждение редактирования количества в деталях
        function confirmDetailsEditQty(lineIndex) {
            detailsEditState[lineIndex] = false;
            // Показываем кнопку сохранения
            document.getElementById('save-details-btn').classList.remove('hidden');
            // Перерисовываем
            if (currentPrintShipment) {
                renderDetailsChecklist(currentPrintShipment, new Date(currentPrintShipment.created_at).toLocaleString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }));
            }
        }

        // Отмена редактирования количества в деталях
        function cancelDetailsEditQty(lineIndex) {
            if (!currentPrintShipment || !currentPrintShipment.lines) return;
            const line = currentPrintShipment.lines[lineIndex];
            if (line && line.originalQty !== undefined) {
                // Восстанавливаем исходное значение
                line.collected_qty = line.originalQty;
            }
            detailsEditState[lineIndex] = false;
            // Перерисовываем
            if (currentPrintShipment) {
                renderDetailsChecklist(currentPrintShipment, new Date(currentPrintShipment.created_at).toLocaleString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }));
            }
        }

        // Подтверждение обработки
        async function confirmProcessing() {
            if (!currentPrintShipment) return;

            // Проверяем, что все товары собраны
            if (!currentPrintShipment.lines || currentPrintShipment.lines.length === 0) {
                showToast('Нет товаров для обработки', 'error');
                return;
            }

            const total = currentPrintShipment.lines.length;
            let collectedCount = 0;
            let hasShortage = false;
            const shortages = [];

            currentPrintShipment.lines.forEach((line, index) => {
                if (collectChecklistState[index] && collectChecklistState[index].collected) {
                    collectedCount++;
                    // Проверяем недостаток
                    if (collectChecklistState[index].collectedQty < collectChecklistState[index].qty) {
                        hasShortage = true;
                        shortages.push({
                            name: line.name,
                            required: collectChecklistState[index].qty,
                            collected: collectChecklistState[index].collectedQty,
                            shortage: collectChecklistState[index].qty - collectChecklistState[index].collectedQty
                        });
                    }
                }
            });

            if (collectedCount !== total) {
                showToast('Не все товары собраны. Завершите сборку всех позиций.', 'error');
                return;
            }

            // Показываем предупреждение о недостатках
            if (hasShortage) {
                const shortageText = shortages.map(s => 
                    `${s.name}: не хватает ${s.shortage}`
                ).join(', ');
                if (!confirm(`Внимание! Обнаружены недостачи:\n${shortageText}\n\nПродолжить обработку заказа с недостачами?`)) {
                    return;
                }
            }

            // Запрашиваем имя сборщика
            const collectorName = prompt('Введите ваше имя (имя сборщика):');
            if (!collectorName || collectorName.trim() === '') {
                showToast('Необходимо ввести имя сборщика', 'error');
                return;
            }

            try {
                // Подготавливаем данные о собранных количествах
                const linesData = currentPrintShipment.lines.map((line, index) => ({
                    collected_qty: collectChecklistState[index] ? collectChecklistState[index].collectedQty : line.qty
                }));
                
                const response = await fetch(API_ENDPOINTS.markPendingConfirmation(currentPrintShipment.id), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        collector_name: collectorName.trim(),
                        lines: linesData
                    })
                });

                if (!response.ok) throw new Error('Ошибка при обновлении статуса');

                // Обновляем статус локально и сохраняем информацию о собранных количествах
                const shipment = allShipments.find(s => s.id === currentPrintShipment.id);
                if (shipment) {
                    shipment.status = 'pending_confirmation';
                    shipment.collector_name = collectorName.trim();
                    // Сохраняем информацию о собранных количествах
                    if (shipment.lines && shipment.lines.length > 0) {
                        shipment.lines.forEach((line, index) => {
                            if (collectChecklistState[index]) {
                                line.collected_qty = collectChecklistState[index].collectedQty;
                            } else {
                                line.collected_qty = line.qty; // Если не было изменений, считаем что собрано полностью
                            }
                        });
                    }
                }

                updateCounters();
                
                // Разблокируем заказ после обработки
                if (lockedShipmentId) {
                    try {
                        await fetch(API_ENDPOINTS.unlock(lockedShipmentId), {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ userId: USER_ID })
                        });
                        lockedShipmentId = null;
                    } catch (error) {
                        console.error('Ошибка разблокировки:', error);
                    }
                }
                
                closeCollectModal();
                applyFilters();
                showToast('Заказ отмечен как обработанный', 'success');
            } catch (error) {
                showToast('Ошибка при обновлении статуса', 'error');
                console.error('Ошибка:', error);
            }
        }


        // Открытие модального окна деталей
        function openDetailsModal(shipment) {
            currentPrintShipment = shipment;
            const modal = document.getElementById('details-modal');
            const title = document.getElementById('details-modal-title');
            const content = document.getElementById('details-modal-content');

            title.textContent = `Заказ ${escapeHtml(shipment.number)}`;
            
            // Сбрасываем состояние редактирования при открытии
            if (shipment.status === 'processed') {
                detailsEditState = {};
            }

            const date = new Date(shipment.created_at);
            const formattedDate = date.toLocaleString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            const isProcessed = shipment.status === 'processed';
            
            // Для обработанных заказов используем интерфейс как в режиме сборки
            if (isProcessed && shipment.lines && shipment.lines.length > 0) {
                renderDetailsChecklist(shipment, formattedDate);
            } else {
                // Для новых заказов - обычный интерфейс
                renderDetailsNormal(shipment, formattedDate);
            }
            
            modal.classList.remove('hidden');
        }

        // Рендеринг деталей в режиме проверки (как режим сборки)
        function renderDetailsChecklist(shipment, formattedDate) {
            const content = document.getElementById('details-modal-content');
            const hasShortages = shipment.lines.some(line => line.collected_qty !== undefined && line.collected_qty < line.qty && line.collected_qty > 0);
            const hasZeroItems = shipment.lines.some(line => line.collected_qty !== undefined && line.collected_qty === 0);
            const checkedCount = shipment.lines.filter(line => line.checked).length;
            
            content.innerHTML = `
                <div class="mb-4 flex items-center justify-between">
                    <div class="text-sm text-slate-400">
                        Всего: <span class="font-semibold text-slate-200">${shipment.lines.length}</span> | 
                        Проверено: <span class="font-semibold text-green-400">${checkedCount}</span>
                    </div>
                    <div class="text-xs text-slate-500">
                        Режим проверки заказа
                    </div>
                </div>
                ${hasShortages || hasZeroItems ? `
                    <div class="mb-4 p-4 ${hasZeroItems ? 'bg-red-900/20 border-red-700/50' : 'bg-yellow-900/20 border-yellow-700/50'} border rounded-lg">
                        <div class="flex items-center gap-2 mb-2">
                            <svg class="w-5 h-5 ${hasZeroItems ? 'text-red-500' : 'text-yellow-500'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                            <span class="${hasZeroItems ? 'text-red-400' : 'text-yellow-400'} font-semibold">
                                ${hasZeroItems ? 'Есть не собранные товары' : 'Есть корректировки количества'}
                            </span>
                        </div>
                    </div>
                ` : ''}
                <div class="overflow-x-auto max-h-[60vh] border border-slate-700 rounded-lg">
                    <table class="w-full border-collapse">
                        <thead class="bg-slate-800 sticky top-0 z-10">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-300 uppercase border-b border-slate-700">Статус</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-300 uppercase border-b border-slate-700">Наименование</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-300 uppercase border-b border-slate-700">Артикул</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-300 uppercase border-b border-slate-700">Место</th>
                                <th class="px-4 py-3 text-center text-xs font-semibold text-slate-300 uppercase border-b border-slate-700">Требуется</th>
                                <th class="px-4 py-3 text-center text-xs font-semibold text-slate-300 uppercase border-b border-slate-700">Собрано</th>
                                <th class="px-4 py-3 text-center text-xs font-semibold text-slate-300 uppercase border-b border-slate-700">Действия</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-800">
                            ${shipment.lines.map((line, index) => {
                                const collectedQty = line.collected_qty !== undefined ? line.collected_qty : line.qty;
                                const isZero = collectedQty === 0;
                                const hasShortage = collectedQty < line.qty && collectedQty > 0;
                                const isFull = collectedQty === line.qty;
                                const isChecked = line.checked || false;
                                
                                // Определяем цвет фона строки
                                let rowBg = 'bg-slate-900';
                                if (isZero) {
                                    rowBg = 'bg-red-900/20';
                                } else if (isFull) {
                                    rowBg = 'bg-green-900/10';
                                } else {
                                    rowBg = 'bg-yellow-900/10';
                                }
                                
                                return `
                                    <tr class="${rowBg} hover:bg-slate-800 transition-colors">
                                        <td class="px-4 py-3 border-b border-slate-800">
                                            ${isChecked ? `
                                                <div class="flex items-center justify-center w-8 h-8 bg-green-600 rounded-full">
                                                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                    </svg>
                                                </div>
                                            ` : `
                                                <div class="w-2 h-2 bg-slate-600 rounded-full"></div>
                                            `}
                                        </td>
                                        <td class="px-4 py-3 border-b border-slate-800">
                                            <div class="font-medium text-slate-100">${escapeHtml(line.name)}</div>
                                            ${isZero ? `
                                                <div class="text-xs text-red-400 mt-0.5 font-semibold">Не собрано</div>
                                            ` : hasShortage ? `
                                                <div class="text-xs text-yellow-500 mt-0.5">Недостаток: ${line.qty - collectedQty}</div>
                                            ` : ''}
                                        </td>
                                        <td class="px-4 py-3 border-b border-slate-800">
                                            <div class="text-sm text-slate-400">${escapeHtml(line.sku)}</div>
                                        </td>
                                        <td class="px-4 py-3 border-b border-slate-800">
                                            <div class="text-sm text-slate-400">${line.location ? escapeHtml(line.location) : '—'}</div>
                                        </td>
                                        <td class="px-4 py-3 text-center border-b border-slate-800">
                                            <div class="text-sm font-semibold text-slate-200">${line.qty}</div>
                                            <div class="text-xs text-slate-500">${escapeHtml(line.uom)}</div>
                                        </td>
                                        <td class="px-4 py-3 text-center border-b border-slate-800">
                                            ${detailsEditState[index] ? `
                                                <div class="flex items-center justify-center gap-1">
                                                    <button onclick="adjustDetailsQty(${index}, -1)" 
                                                            class="w-7 h-7 bg-slate-700 hover:bg-slate-600 text-slate-100 rounded transition-colors flex items-center justify-center text-sm font-bold"
                                                            ${collectedQty <= 0 ? 'opacity-50 cursor-not-allowed' : ''}>
                                                        −
                                                    </button>
                                                    <input type="number" 
                                                           id="details-qty-input-${index}"
                                                           min="0" 
                                                           max="${line.qty}"
                                                           value="${collectedQty}"
                                                           step="1"
                                                           inputmode="numeric"
                                                           pattern="[0-9]*"
                                                           class="w-16 bg-slate-800 border border-slate-600 text-slate-100 rounded px-2 py-1 text-center text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                           onchange="updateDetailsQty(${index}, parseInt(this.value) || 0)"
                                                           oninput="handleDetailsQtyInput(${index}, this)"
                                                           onkeydown="handleDetailsQtyKeydown(event, ${index}, ${line.qty})">
                                                    <button onclick="adjustDetailsQty(${index}, 1)" 
                                                            class="w-7 h-7 bg-slate-700 hover:bg-slate-600 text-slate-100 rounded transition-colors flex items-center justify-center text-sm font-bold"
                                                            ${collectedQty >= line.qty ? 'opacity-50 cursor-not-allowed' : ''}>
                                                        +
                                                    </button>
                                                </div>
                                                <button onclick="setDetailsFullQty(${index}, ${line.qty})" 
                                                        class="mt-1 text-xs text-blue-400 hover:text-blue-300 transition-colors">
                                                    Макс
                                                </button>
                                            ` : `
                                                <div class="text-sm font-semibold ${isZero ? 'text-red-500' : hasShortage ? 'text-yellow-500' : 'text-green-500'}">
                                                    ${collectedQty}
                                                </div>
                                                <div class="text-xs text-slate-500">${escapeHtml(line.uom)}</div>
                                            `}
                                        </td>
                                        <td class="px-4 py-3 text-center border-b border-slate-800">
                                            ${detailsEditState[index] ? `
                                                <div class="flex flex-col gap-1">
                                                    <button onclick="confirmDetailsEditQty(${index})" 
                                                            class="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white text-xs font-semibold rounded transition-colors flex items-center justify-center gap-1">
                                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                        </svg>
                                                        Подтвердить
                                                    </button>
                                                    <button onclick="cancelDetailsEditQty(${index})" 
                                                            class="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 text-slate-200 text-xs font-medium rounded transition-colors">
                                                        Отмена
                                                    </button>
                                                </div>
                                            ` : `
                                                <div class="flex flex-col gap-1">
                                                    <button onclick="startDetailsEditQty(${index})" 
                                                            class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-xs font-semibold rounded transition-colors flex items-center justify-center gap-1">
                                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                                        </svg>
                                                        Редактировать
                                                    </button>
                                                    <button onclick="toggleLineChecked(${index}, ${!isChecked})" 
                                                            class="px-3 py-1.5 ${isChecked ? 'bg-green-600 hover:bg-green-700' : 'bg-slate-700 hover:bg-slate-600'} text-white text-xs font-medium rounded transition-colors">
                                                        ${isChecked ? '✓ Проверено' : 'Проверить'}
                                                    </button>
                                                </div>
                                            `}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Рендеринг деталей для новых заказов (обычный режим)
        function renderDetailsNormal(shipment, formattedDate) {
            const content = document.getElementById('details-modal-content');
            
            let linesHtml = '';
            if (shipment.lines && shipment.lines.length > 0) {
                linesHtml = `
                    <div class="overflow-x-auto mt-4">
                        <table class="w-full border-collapse">
                            <thead>
                                <tr class="bg-slate-700">
                                    <th class="border border-slate-600 px-4 py-2 text-left text-slate-200">Артикул</th>
                                    <th class="border border-slate-600 px-4 py-2 text-left text-slate-200">Наименование</th>
                                    <th class="border border-slate-600 px-4 py-2 text-right text-slate-200">Количество</th>
                                    <th class="border border-slate-600 px-4 py-2 text-left text-slate-200">Ед. изм.</th>
                                    <th class="border border-slate-600 px-4 py-2 text-left text-slate-200">Место хранения</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${shipment.lines.map((line, idx) => `
                                    <tr class="${idx % 2 === 0 ? 'bg-slate-800' : 'bg-slate-900'}">
                                        <td class="border border-slate-600 px-4 py-2 text-slate-300">${escapeHtml(line.sku)}</td>
                                        <td class="border border-slate-600 px-4 py-2 text-slate-300">${escapeHtml(line.name)}</td>
                                        <td class="border border-slate-600 px-4 py-2 text-right text-slate-300">${line.qty}</td>
                                        <td class="border border-slate-600 px-4 py-2 text-slate-300">${escapeHtml(line.uom)}</td>
                                        <td class="border border-slate-600 px-4 py-2 text-slate-300">${escapeHtml(line.location || '')}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                linesHtml = '<p class="text-slate-400 mt-4">Нет данных о позициях</p>';
            }

            content.innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="text-slate-400 text-sm mb-1">Клиент</div>
                            <div class="text-slate-100 font-semibold">${escapeHtml(shipment.customer_name)}</div>
                        </div>
                        <div>
                            <div class="text-slate-400 text-sm mb-1">Направление</div>
                            <div class="text-slate-100 font-semibold">${escapeHtml(shipment.destination)}</div>
                        </div>
                        <div>
                            <div class="text-slate-400 text-sm mb-1">Дата создания</div>
                            <div class="text-slate-100">${formattedDate}</div>
                        </div>
                        <div>
                            <div class="text-slate-400 text-sm mb-1">Статус</div>
                            <div class="text-slate-100">
                                ${shipment.status === 'processed' ? 
                                    '<span class="bg-green-600 text-white text-xs font-semibold px-2 py-1 rounded">Обработано</span>' : 
                                    '<span class="bg-blue-600 text-white text-xs font-semibold px-2 py-1 rounded">Новый</span>'
                                }
                            </div>
                        </div>
                        <div>
                            <div class="text-slate-400 text-sm mb-1">Позиций</div>
                            <div class="text-slate-100">${shipment.items_count}</div>
                        </div>
                        <div>
                            <div class="text-slate-400 text-sm mb-1">Общее количество</div>
                            <div class="text-slate-100">${shipment.total_qty} ед.</div>
                        </div>
                        ${shipment.weight ? `
                            <div>
                                <div class="text-slate-400 text-sm mb-1">Вес</div>
                                <div class="text-slate-100">${shipment.weight} кг</div>
                            </div>
                        ` : ''}
                    </div>
                    ${shipment.comment ? `
                        <div>
                            <div class="text-slate-400 text-sm mb-1">Комментарий</div>
                            <div class="text-slate-100">${escapeHtml(shipment.comment)}</div>
                        </div>
                    ` : ''}
                    ${linesHtml}
                </div>
            `;

            modal.classList.remove('hidden');
        }

        // Закрытие модального окна деталей
        function closeDetailsModal() {
            document.getElementById('details-modal').classList.add('hidden');
            // Скрываем кнопку сохранения
            document.getElementById('save-details-btn').classList.add('hidden');
            // Сбрасываем состояние редактирования
            detailsEditState = {};
        }

        // Переключение чекбокса проверки товара
        function toggleLineChecked(lineIndex, checked) {
            if (!currentPrintShipment || !currentPrintShipment.lines) return;
            const line = currentPrintShipment.lines[lineIndex];
            if (line) {
                line.checked = checked;
                // Показываем кнопку сохранения при любом изменении
                document.getElementById('save-details-btn').classList.remove('hidden');
            }
        }

        // Изменение количества в деталях
        function adjustDetailsQty(lineIndex, delta) {
            if (!currentPrintShipment || !currentPrintShipment.lines) return;
            const line = currentPrintShipment.lines[lineIndex];
            if (!line) return;
            
            const currentQty = line.collected_qty !== undefined ? line.collected_qty : line.qty;
            const newQty = Math.max(0, Math.min(line.qty, currentQty + delta));
            updateDetailsQty(lineIndex, newQty);
        }

        // Установка максимального количества в деталях
        function setDetailsFullQty(lineIndex, maxQty) {
            updateDetailsQty(lineIndex, maxQty);
        }

        // Обновление количества в деталях
        function updateDetailsQty(lineIndex, qty) {
            if (!currentPrintShipment || !currentPrintShipment.lines) return;
            const line = currentPrintShipment.lines[lineIndex];
            if (!line) return;

            const maxQty = line.qty;
            const newQty = Math.min(Math.max(0, Math.floor(qty)), maxQty);
            
            line.collected_qty = newQty;

            // Обновляем значение в поле ввода
            const qtyInput = document.getElementById(`details-qty-input-${lineIndex}`);
            if (qtyInput) {
                qtyInput.value = newQty;
            }
        }

        // Обработка ввода количества в деталях
        function handleDetailsQtyInput(lineIndex, inputElement) {
            let value = inputElement.value;
            value = value.replace(/[^0-9]/g, '');
            if (value === '') value = '0';
            
            const numValue = parseInt(value) || 0;
            const line = currentPrintShipment.lines[lineIndex];
            const maxQty = line.qty;
            
            if (numValue > maxQty) {
                inputElement.value = maxQty;
                updateDetailsQty(lineIndex, maxQty);
            } else {
                inputElement.value = numValue;
                updateDetailsQty(lineIndex, numValue);
            }
        }

        // Обработка клавиш для поля количества в деталях
        function handleDetailsQtyKeydown(event, lineIndex, maxQty) {
            const allowedKeys = ['Backspace', 'Delete', 'Tab', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'];
            
            if (allowedKeys.includes(event.key)) {
                if (event.key === 'ArrowUp') {
                    event.preventDefault();
                    adjustDetailsQty(lineIndex, 1);
                } else if (event.key === 'ArrowDown') {
                    event.preventDefault();
                    adjustDetailsQty(lineIndex, -1);
                }
                return;
            }
            
            if (!/[0-9]/.test(event.key) && !event.ctrlKey && !event.metaKey) {
                event.preventDefault();
            }
        }

        // Сохранение изменений в деталях
        async function saveDetailsChanges() {
            if (!currentPrintShipment) return;

            try {
                // Отправляем обновленные данные на сервер
                const response = await fetch(API_ENDPOINTS.markProcessed(currentPrintShipment.id), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        lines: currentPrintShipment.lines.map(line => ({
                            sku: line.sku,
                            collected_qty: line.collected_qty !== undefined ? line.collected_qty : line.qty,
                            checked: line.checked || false
                        }))
                    })
                });

                if (!response.ok) throw new Error('Ошибка при сохранении изменений');

                // Обновляем локальные данные
                const shipment = allShipments.find(s => s.id === currentPrintShipment.id);
                if (shipment && shipment.lines) {
                    currentPrintShipment.lines.forEach((line, idx) => {
                        if (shipment.lines[idx]) {
                            shipment.lines[idx].collected_qty = line.collected_qty;
                            shipment.lines[idx].checked = line.checked;
                        }
                    });
                }

                // Скрываем кнопку сохранения
                document.getElementById('save-details-btn').classList.add('hidden');
                
                // Обновляем отображение
                applyFilters();
                showToast('Изменения сохранены', 'success');
            } catch (error) {
                showToast('Ошибка при сохранении изменений', 'error');
                console.error('Ошибка:', error);
            }
        }

        // Показ тостов
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const bgColor = type === 'error' ? 'bg-red-600' : type === 'success' ? 'bg-green-600' : 'bg-blue-600';
            
            toast.className = `${bgColor} text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-2 animate-slide-in`;
            toast.innerHTML = `
                <span>${escapeHtml(message)}</span>
                <button onclick="this.parentElement.remove()" class="ml-2 hover:opacity-75">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            `;

            container.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // Автообновление
        function startAutoRefresh() {
            // Обновление каждые 60 секунд
            autoRefreshInterval = setInterval(loadShipments, 60000);
        }

        // Экранирование HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Открытие модального окна с полным наименованием
        function openNameModal(name, sku, location, qty, collectedQty) {
            const modal = document.getElementById('name-modal');
            const nameEl = document.getElementById('name-modal-name');
            const skuEl = document.getElementById('name-modal-sku');
            const locationEl = document.getElementById('name-modal-location');
            const qtyEl = document.getElementById('name-modal-qty');
            const collectedEl = document.getElementById('name-modal-collected');
            
            nameEl.textContent = name || '';
            skuEl.textContent = sku || '—';
            locationEl.textContent = location || '—';
            qtyEl.textContent = qty !== undefined ? qty : '—';
            collectedEl.textContent = collectedQty !== undefined ? collectedQty : '—';
            
            modal.classList.remove('hidden');
            
            // Блокируем скролл основного контента только если модальное окно сборки не открыто
            const collectModal = document.getElementById('collect-modal');
            if (collectModal.classList.contains('hidden')) {
                document.body.style.overflow = 'hidden';
            }
        }

        // Закрытие модального окна с полным наименованием
        function closeNameModal() {
            const modal = document.getElementById('name-modal');
            modal.classList.add('hidden');
            
            // Разблокируем скролл основного контента только если модальное окно сборки не открыто
            const collectModal = document.getElementById('collect-modal');
            if (collectModal.classList.contains('hidden')) {
                document.body.style.overflow = '';
            }
        }

        // Показ модального окна с полным наименованием (для совместимости с onclick)
        function showNameTooltip(event, name, sku, location, qty, collectedQty) {
            // Предотвращаем всплытие события
            event.stopPropagation();
            
            // Открываем модальное окно
            openNameModal(name, sku, location, qty, collectedQty);
        }

        // Функция для совместимости (больше не используется, но оставлена для безопасности)
        function hideNameTooltip(event) {
            // Больше не используется, так как используем модальное окно
        }

        // Открытие модального окна подтверждения
        function openConfirmModal(shipment) {
            currentPrintShipment = shipment;
            
            const modal = document.getElementById('confirm-modal');
            const content = document.getElementById('confirm-modal-content');
            const numberEl = document.getElementById('confirm-modal-number');
            const collectorEl = document.getElementById('confirm-modal-collector');
            const warningsEl = document.getElementById('confirm-warnings');
            
            numberEl.textContent = `Заказ ${shipment.number}`;
            collectorEl.textContent = shipment.collector_name ? `Сборщик: ${shipment.collector_name}` : '';
            
            // Проверяем на недостачи и неполную сборку
            let hasShortages = false;
            let hasZeroItems = false;
            const shortages = [];
            const zeroItems = [];
            
            if (shipment.lines && shipment.lines.length > 0) {
                shipment.lines.forEach((line, index) => {
                    const collectedQty = line.collected_qty !== undefined ? line.collected_qty : line.qty;
                    if (collectedQty === 0) {
                        hasZeroItems = true;
                        zeroItems.push({
                            name: line.name,
                            required: line.qty
                        });
                    } else if (collectedQty < line.qty) {
                        hasShortages = true;
                        shortages.push({
                            name: line.name,
                            required: line.qty,
                            collected: collectedQty,
                            shortage: line.qty - collectedQty
                        });
                    }
                });
            }
            
            // Отображаем предупреждения
            if (hasZeroItems || hasShortages) {
                let warningsHtml = '<div class="p-4 rounded-lg border-2 ';
                if (hasZeroItems) {
                    warningsHtml += 'bg-red-900/30 border-red-500/50">';
                    warningsHtml += '<div class="flex items-center gap-2 mb-2">';
                    warningsHtml += '<svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">';
                    warningsHtml += '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>';
                    warningsHtml += '</svg>';
                    warningsHtml += '<span class="text-red-400 font-bold text-base">ВНИМАНИЕ: Есть не собранные товары!</span>';
                    warningsHtml += '</div>';
                    warningsHtml += '<div class="text-sm text-red-300 mb-2">';
                    warningsHtml += `${zeroItems.length} позиций не собрано: ${zeroItems.map(i => i.name).slice(0, 3).join(', ')}${zeroItems.length > 3 ? '...' : ''}`;
                    warningsHtml += '</div>';
                } else if (hasShortages) {
                    warningsHtml += 'bg-yellow-900/30 border-yellow-500/50">';
                    warningsHtml += '<div class="flex items-center gap-2 mb-2">';
                    warningsHtml += '<svg class="w-5 h-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">';
                    warningsHtml += '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>';
                    warningsHtml += '</svg>';
                    warningsHtml += '<span class="text-yellow-400 font-bold text-base">ВНИМАНИЕ: Обнаружены недостачи!</span>';
                    warningsHtml += '</div>';
                    warningsHtml += '<div class="text-sm text-yellow-300 mb-2">';
                    const totalShortage = shortages.reduce((sum, s) => sum + s.shortage, 0);
                    warningsHtml += `${shortages.length} позиций с недостачей. Всего не хватает: ${totalShortage} ед.`;
                    warningsHtml += '</div>';
                }
                warningsHtml += '</div>';
                warningsEl.innerHTML = warningsHtml;
            } else {
                warningsEl.innerHTML = '';
            }
            
            // Инициализация состояния чеклиста для подтверждения
            confirmChecklistState = {};
            confirmEditState = {};
            if (shipment.lines && shipment.lines.length > 0) {
                shipment.lines.forEach((line, index) => {
                    confirmChecklistState[index] = {
                        qty: line.qty,
                        collectedQty: line.collected_qty !== undefined ? line.collected_qty : line.qty,
                        confirmed: false // Статус подтверждения товара
                    };
                });
            }
            
            // Рендерим чеклист для просмотра и редактирования
            renderConfirmChecklist(shipment);
            
            // Обновляем прогресс подтверждения
            updateConfirmProgress();
            
            // Инициализируем swipe для подтверждения товаров после открытия модального окна
            setTimeout(() => {
                initSwipeToConfirmItem();
            }, 300);
            
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        
        // Рендеринг чеклиста для подтверждения (только просмотр)
        function renderConfirmChecklist(shipment) {
            const content = document.getElementById('confirm-modal-content');
            
            if (!shipment.lines || shipment.lines.length === 0) {
                content.innerHTML = '<p class="text-slate-400 text-center py-8">Нет позиций для проверки</p>';
                return;
            }
            
            // Сохраняем позицию скролла перед перерисовкой
            let savedScrollTop = 0;
            const modalScrollContainer = document.querySelector('#confirm-modal .overflow-y-auto');
            if (modalScrollContainer) {
                savedScrollTop = modalScrollContainer.scrollTop;
            }
            
            // Сортируем: сначала неполностью собранные
            const sortedLines = [...shipment.lines].sort((a, b) => {
                const aCollected = a.collected_qty !== undefined ? a.collected_qty : a.qty;
                const bCollected = b.collected_qty !== undefined ? b.collected_qty : b.qty;
                const aComplete = aCollected === a.qty;
                const bComplete = bCollected === b.qty;
                if (aComplete === bComplete) return 0;
                return aComplete ? 1 : -1;
            });
            
            let tableHtml = `
                <table class="w-full border-collapse">
                    <thead class="hidden md:table-header-group">
                        <tr class="bg-slate-700/50">
                            <th class="px-1 md:px-2 py-1 md:py-3 text-left text-[8px] md:text-sm text-slate-300 w-8 md:w-12">Статус</th>
                            <th class="px-1 md:px-2 py-1 md:py-3 text-left text-[8px] md:text-sm text-slate-300 name-header-col" style="max-width: 300px;">Наименование</th>
                            <th class="px-1 md:px-2 py-1 md:py-3 text-left text-[8px] md:text-sm text-slate-300 w-20">Артикул</th>
                            <th class="px-1 md:px-2 py-1 md:py-3 text-left text-[8px] md:text-sm text-slate-300 w-24" style="max-width: 150px;">Место</th>
                            <th class="px-1 md:px-2 py-1 md:py-3 text-right text-[8px] md:text-sm text-slate-300 w-12 md:w-20">Требуется</th>
                            <th class="px-1 md:px-2 py-1 md:py-3 text-right text-[8px] md:text-sm text-slate-300 w-16 md:w-28">Собрано</th>
                            <th class="px-1 md:px-2 py-1 md:py-3 text-center text-[8px] md:text-sm text-slate-300 w-20 md:w-40">Действия</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y-0 md:divide-y divide-slate-800">
            `;
            
            sortedLines.forEach((line, sortedIndex) => {
                // Находим оригинальный индекс в shipment.lines
                const originalIndex = shipment.lines.findIndex(l => l.sku === line.sku && l.name === line.name);
                const index = originalIndex >= 0 ? originalIndex : sortedIndex;
                
                const state = confirmChecklistState[index] || { qty: line.qty, collectedQty: line.collected_qty !== undefined ? line.collected_qty : line.qty, confirmed: false };
                const collectedQty = state.collectedQty;
                const hasShortage = collectedQty < line.qty && collectedQty > 0;
                const isZero = collectedQty === 0;
                const isComplete = collectedQty === line.qty;
                const isEditing = confirmEditState[index];
                const isConfirmed = state.confirmed || false;
                
                const rowBg = isZero ? 'bg-red-900/20' : hasShortage ? 'bg-yellow-900/20' : isComplete ? 'bg-green-900/20' : 'bg-slate-900';
                
                // Мобильная версия
                tableHtml += `
                    <tr class="md:hidden">
                        <td colspan="7" class="p-0 w-full">
                            <div class="${rowBg} border-b border-slate-700/50 mb-1.5 rounded overflow-hidden w-full">
                                <div class="px-2 py-1.5">
                                    <div class="font-medium text-xs leading-tight ${hasShortage || isZero ? 'text-orange-400' : 'text-slate-100'} mb-0.5 line-clamp-2">
                                        ${escapeHtml(line.name)}
                                    </div>
                                    <div class="flex items-center gap-2 text-[9px] text-slate-500">
                                        <span>${escapeHtml(line.sku)}</span>
                                        ${line.location ? `<span class="text-blue-400">${escapeHtml(line.location)}</span>` : ''}
                                    </div>
                                    <div class="flex items-center justify-between mt-1">
                                        <div class="text-right">
                                            <div class="text-[9px] text-slate-500">Треб</div>
                                            <div class="text-sm font-semibold text-slate-200">${line.qty}</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-[9px] text-slate-500">Собр</div>
                                            ${isEditing ? `
                                                <div class="flex items-center gap-0.5">
                                                    <button onclick="confirmAdjustQty(${index}, -1)" 
                                                            class="w-5 h-5 bg-slate-700 hover:bg-slate-600 text-slate-100 rounded transition-colors flex items-center justify-center text-[10px] font-bold touch-manipulation"
                                                            ${collectedQty <= 0 ? 'opacity-50 cursor-not-allowed' : ''}>
                                                        −
                                                    </button>
                                                    <input type="number" 
                                                           id="confirm-qty-input-mobile-${index}"
                                                           min="0" 
                                                           max="${line.qty}"
                                                           value="${collectedQty}"
                                                           step="1"
                                                           inputmode="numeric"
                                                           pattern="[0-9]*"
                                                           class="w-10 bg-slate-800 border border-slate-600 text-slate-100 rounded px-0.5 py-0.5 text-center text-[10px] font-semibold focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                           onchange="confirmUpdateCollectedQty(${index}, parseInt(this.value) || 0)"
                                                           onkeydown="handleQtyKeydown(event, ${index}, ${line.qty})">
                                                    <button onclick="confirmAdjustQty(${index}, 1)" 
                                                            class="w-5 h-5 bg-slate-700 hover:bg-slate-600 text-slate-100 rounded transition-colors flex items-center justify-center text-[10px] font-bold touch-manipulation"
                                                            ${collectedQty >= line.qty ? 'opacity-50 cursor-not-allowed' : ''}>
                                                        +
                                                    </button>
                                                </div>
                                            ` : `
                                                <div class="text-sm font-semibold ${isZero ? 'text-red-400' : hasShortage ? 'text-yellow-400' : 'text-green-400'}">${collectedQty}</div>
                                            `}
                                        </div>
                                    </div>
                                </div>
                                <div class="px-2 py-1 border-t border-slate-700/30">
                                    ${isEditing ? `
                                        <div class="flex gap-1.5 w-full">
                                            <button onclick="confirmConfirmEditQty(${index})" 
                                                    class="flex-1 px-2 py-1 bg-green-600 hover:bg-green-700 text-white text-[10px] font-semibold rounded transition-colors flex items-center justify-center gap-1 touch-manipulation">
                                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                </svg>
                                                Подтвердить
                                            </button>
                                            <button onclick="confirmCancelEditQty(${index})" 
                                                    class="px-2 py-1 bg-slate-700 hover:bg-slate-600 text-slate-200 text-[10px] font-medium rounded transition-colors touch-manipulation">
                                                Отмена
                                            </button>
                                        </div>
                                    ` : `
                                        <div class="flex gap-1.5 w-full items-center">
                                            ${isConfirmed ? `
                                                <button onclick="confirmStartEditQty(${index})" 
                                                        class="px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white text-[10px] font-medium rounded transition-colors flex items-center justify-center gap-1 touch-manipulation">
                                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                                    </svg>
                                                    Ред.
                                                </button>
                                            ` : `
                                                <button onclick="confirmStartEditQty(${index})" 
                                                        class="px-1.5 py-1 bg-blue-600 hover:bg-blue-700 text-white text-[9px] font-medium rounded transition-colors flex items-center justify-center touch-manipulation">
                                                    Ред.
                                                </button>
                                                <!-- Swipe-to-confirm для мобильных - выровнен справа -->
                                                <div class="ml-auto relative overflow-hidden rounded-lg" style="max-width: 50%; min-width: 120px;">
                                                    <div id="swipe-confirm-item-track-${index}" class="relative w-full h-10 bg-slate-700 rounded-lg overflow-hidden border-2 border-slate-600" style="touch-action: pan-x; cursor: grab; user-select: none; -webkit-user-select: none;">
                                                        <div id="swipe-confirm-item-slider-${index}" class="absolute left-0 top-0 h-full bg-green-600 flex items-center justify-center transition-none z-20" style="width: 50px; min-width: 50px;">
                                                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3">
                                                                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path>
                                                            </svg>
                                                        </div>
                                                        <div id="swipe-confirm-item-text-${index}" class="absolute inset-0 flex items-center justify-center text-slate-200 font-bold text-[10px] pointer-events-none z-10 px-2" style="left: 50px;">
                                                            <span>→ Подтвердить</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            `}
                                        </div>
                                    `}
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
                
                // Десктоп версия
                tableHtml += `
                    <tr class="hidden md:table-row ${rowBg}">
                        <td class="px-1 md:px-1 py-1 md:py-2 border-b border-slate-800 w-8 md:w-10 text-center">
                            ${isComplete ? `
                                <svg class="w-4 h-4 md:w-5 md:h-5 text-green-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            ` : isZero ? `
                                <svg class="w-4 h-4 md:w-5 md:h-5 text-red-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            ` : `
                                <svg class="w-4 h-4 md:w-5 md:h-5 text-yellow-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                            `}
                        </td>
                        <td class="px-1 md:px-2 py-1 md:py-2 border-b border-slate-800 min-w-0 hidden md:table-cell" style="max-width: 200px;">
                            <div class="font-medium text-[10px] md:text-xs leading-tight line-clamp-2 ${hasShortage || isZero ? 'text-orange-400' : 'text-slate-100'}">
                                ${escapeHtml(line.name)}
                            </div>
                        </td>
                        <td class="px-1 md:px-2 py-1 md:py-2 border-b border-slate-800 text-[9px] md:text-xs text-slate-300 hidden md:table-cell">${escapeHtml(line.sku)}</td>
                        <td class="px-1 md:px-2 py-1 md:py-2 border-b border-slate-800 text-[9px] md:text-xs text-blue-400 hidden md:table-cell" style="max-width: 150px;">
                            <div class="line-clamp-2">${line.location ? escapeHtml(line.location) : '—'}</div>
                        </td>
                        <td class="px-1 md:px-2 py-1 md:py-2 border-b border-slate-800 text-right text-[9px] md:text-xs text-slate-300 hidden md:table-cell">${line.qty}</td>
                        <td class="px-1 md:px-2 py-1 md:py-2 border-b border-slate-800 text-right text-[9px] md:text-xs hidden md:table-cell">
                            ${isEditing ? `
                                <div class="flex items-center gap-1 justify-end">
                                    <button onclick="confirmAdjustQty(${index}, -1)" 
                                            class="w-6 h-6 bg-slate-700 hover:bg-slate-600 text-slate-100 rounded transition-colors flex items-center justify-center text-xs font-bold"
                                            ${collectedQty <= 0 ? 'opacity-50 cursor-not-allowed' : ''}>
                                        −
                                    </button>
                                    <input type="number" 
                                           id="confirm-qty-input-${index}"
                                           min="0" 
                                           max="${line.qty}"
                                           value="${collectedQty}"
                                           step="1"
                                           class="w-12 bg-slate-800 border border-slate-600 text-slate-100 rounded px-1 py-0.5 text-center text-xs font-semibold focus:outline-none focus:ring-1 focus:ring-blue-500"
                                           onchange="confirmUpdateCollectedQty(${index}, parseInt(this.value) || 0)"
                                           onkeydown="handleQtyKeydown(event, ${index}, ${line.qty})">
                                    <button onclick="confirmAdjustQty(${index}, 1)" 
                                            class="w-6 h-6 bg-slate-700 hover:bg-slate-600 text-slate-100 rounded transition-colors flex items-center justify-center text-xs font-bold"
                                            ${collectedQty >= line.qty ? 'opacity-50 cursor-not-allowed' : ''}>
                                        +
                                    </button>
                                    <button onclick="confirmSetFullQty(${index}, ${line.qty})" 
                                            class="px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white text-[8px] font-medium rounded transition-colors">
                                        Макс
                                    </button>
                                </div>
                            ` : `
                                <span class="${isZero ? 'text-red-400' : hasShortage ? 'text-yellow-400' : 'text-green-400'} font-semibold">${collectedQty}</span>
                            `}
                        </td>
                        <td class="px-1 md:px-2 py-1 md:py-2 border-b border-slate-800 text-center hidden md:table-cell">
                            ${isEditing ? `
                                <div class="flex gap-1 md:gap-2 items-center justify-center">
                                    <button onclick="confirmConfirmEditQty(${index})" 
                                            class="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white text-xs font-semibold rounded transition-colors flex items-center gap-1">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                        Сохранить
                                    </button>
                                    <button onclick="confirmCancelEditQty(${index})" 
                                            class="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 text-slate-200 text-xs font-medium rounded transition-colors">
                                        Отмена
                                    </button>
                                </div>
                            ` : `
                                <div class="flex gap-1 md:gap-2 items-center justify-center">
                                    <button onclick="confirmStartEditQty(${index})" 
                                            class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-xs font-semibold rounded transition-colors flex items-center gap-1">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                        </svg>
                                        Редактировать
                                    </button>
                                    ${!isConfirmed ? `
                                        <button onclick="confirmItem(${index})" 
                                                class="px-4 py-1.5 bg-green-600 hover:bg-green-700 text-white text-xs font-semibold rounded transition-colors flex items-center gap-1">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                            </svg>
                                            Подтвердить
                                        </button>
                                    ` : `
                                        <div class="px-4 py-1.5 bg-green-700 text-white text-xs font-semibold rounded flex items-center gap-1">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                            </svg>
                                            Подтверждено
                                        </div>
                                    `}
                                </div>
                            `}
                        </td>
                    </tr>
                `;
            });
            
            tableHtml += '</tbody></table>';
            content.innerHTML = tableHtml;
            
            // Восстанавливаем позицию скролла после перерисовки
            requestAnimationFrame(() => {
                const scrollContainer = document.querySelector('#confirm-modal .overflow-y-auto');
                if (scrollContainer) {
                    scrollContainer.scrollTop = savedScrollTop;
                } else {
                    setTimeout(() => {
                        const delayedScrollContainer = document.querySelector('#confirm-modal .overflow-y-auto');
                        if (delayedScrollContainer) {
                            delayedScrollContainer.scrollTop = savedScrollTop;
                        }
                    }, 10);
                }
            });
            
            // Инициализируем swipe для подтверждения товаров
            setTimeout(() => {
                initSwipeToConfirmItem();
            }, 200);
        }
        
        // Инициализация swipe-to-confirm для каждого товара в режиме подтверждения
        let swipeConfirmItemHandlers = {};
        let swipeConfirmItemState = {};
        
        function initSwipeToConfirmItem() {
            if (!currentPrintShipment || !currentPrintShipment.lines) return;
            
            setTimeout(() => {
                currentPrintShipment.lines.forEach((line, index) => {
                    const track = document.getElementById(`swipe-confirm-item-track-${index}`);
                    const slider = document.getElementById(`swipe-confirm-item-slider-${index}`);
                    const text = document.getElementById(`swipe-confirm-item-text-${index}`);
                    
                    if (!track || !slider || !text) {
                        return;
                    }
                    
                    // Удаляем старые обработчики
                    if (swipeConfirmItemHandlers[index]) {
                        const oldHandlers = swipeConfirmItemHandlers[index];
                        track.removeEventListener('touchstart', oldHandlers.handleStart);
                        track.removeEventListener('touchmove', oldHandlers.handleMove);
                        track.removeEventListener('touchend', oldHandlers.handleEnd);
                        track.removeEventListener('touchcancel', oldHandlers.handleEnd);
                        track.removeEventListener('mousedown', oldHandlers.handleStart);
                        if (oldHandlers.mouseMoveHandler) {
                            document.removeEventListener('mousemove', oldHandlers.mouseMoveHandler);
                        }
                        if (oldHandlers.mouseUpHandler) {
                            document.removeEventListener('mouseup', oldHandlers.mouseUpHandler);
                        }
                    }
                    
                    const state = confirmChecklistState[index];
                    if (state && state.confirmed) {
                        // Если товар уже подтвержден, показываем как подтвержденный
                        slider.style.width = '100%';
                        slider.style.transition = 'width 0.3s ease-out';
                        text.textContent = '✓ Подтверждено';
                        text.style.color = 'white';
                        text.style.left = '0';
                        track.parentElement.classList.add('completed-confirm-item');
                        swipeConfirmItemState[index] = {
                            isDragging: false,
                            hasConfirmed: true,
                            startX: 0,
                            currentX: 0
                        };
                        return;
                    }
                    
                    // Инициализируем состояние
                    swipeConfirmItemState[index] = {
                        isDragging: false,
                        hasConfirmed: false,
                        startX: 0,
                        currentX: 0
                    };
                    
                    // Сбрасываем состояние
                    slider.style.width = '50px';
                    slider.style.transition = 'none';
                    text.textContent = '→ Подтвердить';
                    text.style.color = '';
                    text.style.left = '50px';
                    track.parentElement.classList.remove('completed-confirm-item', 'swiping-confirm-item');
                    
                    track.style.pointerEvents = 'auto';
                    track.style.cursor = 'grab';
                    
                    const sliderMinWidth = 50;
                    const threshold = 0.75;
                    
                    const updateSlider = () => {
                        const trackWidth = track.offsetWidth;
                        const maxWidth = trackWidth - sliderMinWidth;
                        const deltaX = swipeConfirmItemState[index].currentX - swipeConfirmItemState[index].startX;
                        const newWidth = Math.min(Math.max(sliderMinWidth + deltaX, sliderMinWidth), trackWidth);
                        
                        slider.style.width = `${newWidth}px`;
                        
                        const percentage = maxWidth > 0 ? (newWidth - sliderMinWidth) / maxWidth : 0;
                        
                        if (newWidth < trackWidth) {
                            text.style.left = `${newWidth}px`;
                        } else {
                            text.style.left = '0';
                        }
                        
                        if (percentage >= threshold && !swipeConfirmItemState[index].hasConfirmed) {
                            swipeConfirmItemState[index].hasConfirmed = true;
                            swipeConfirmItemState[index].isDragging = false;
                            track.parentElement.classList.add('completed-confirm-item');
                            text.textContent = '✓ Подтверждено';
                            text.style.color = 'white';
                            text.style.left = '0';
                            slider.style.width = '100%';
                            track.style.cursor = 'grab';
                            track.parentElement.classList.remove('swiping-confirm-item');
                            
                            setTimeout(() => {
                                if (swipeConfirmItemState[index] && swipeConfirmItemState[index].hasConfirmed) {
                                    confirmItem(index);
                                }
                            }, 150);
                        } else if (percentage < threshold && swipeConfirmItemState[index].hasConfirmed) {
                            swipeConfirmItemState[index].hasConfirmed = false;
                            track.parentElement.classList.remove('completed-confirm-item');
                            text.textContent = '→ Подтвердить';
                            text.style.color = '';
                        }
                    };
                    
                    const handleStart = (e) => {
                        const currentState = confirmChecklistState[index];
                        if (currentState && currentState.confirmed) {
                            return;
                        }
                        if (swipeConfirmItemState[index].hasConfirmed) {
                            return;
                        }
                        
                        const touch = e.touches ? e.touches[0] : e;
                        const trackRect = track.getBoundingClientRect();
                        swipeConfirmItemState[index].startX = touch.clientX - trackRect.left;
                        swipeConfirmItemState[index].currentX = swipeConfirmItemState[index].startX;
                        swipeConfirmItemState[index].isDragging = true;
                        slider.style.transition = 'none';
                        track.style.cursor = 'grabbing';
                        track.parentElement.classList.add('swiping-confirm-item');
                        e.preventDefault();
                        e.stopPropagation();
                    };
                    
                    const handleMove = (e) => {
                        if (!swipeConfirmItemState[index] || !swipeConfirmItemState[index].isDragging) return;
                        if (swipeConfirmItemState[index].hasConfirmed) return;
                        
                        const currentState = confirmChecklistState[index];
                        if (currentState && currentState.confirmed) {
                            return;
                        }
                        
                        const touch = e.touches ? e.touches[0] : e;
                        const trackRect = track.getBoundingClientRect();
                        swipeConfirmItemState[index].currentX = touch.clientX - trackRect.left;
                        updateSlider();
                        e.preventDefault();
                        e.stopPropagation();
                    };
                    
                    const handleEnd = () => {
                        if (!swipeConfirmItemState[index] || !swipeConfirmItemState[index].isDragging) return;
                        swipeConfirmItemState[index].isDragging = false;
                        track.style.cursor = 'grab';
                        slider.style.transition = 'width 0.3s ease-out';
                        track.parentElement.classList.remove('swiping-confirm-item');
                        
                        if (!swipeConfirmItemState[index].hasConfirmed) {
                            slider.style.width = '50px';
                            text.style.left = '50px';
                            swipeConfirmItemState[index].startX = 0;
                            swipeConfirmItemState[index].currentX = 0;
                        }
                    };
                    
                    const handlers = { handleStart, handleMove, handleEnd };
                    swipeConfirmItemHandlers[index] = handlers;
                    
                    track.addEventListener('touchstart', handleStart, { passive: false });
                    track.addEventListener('touchmove', handleMove, { passive: false });
                    track.addEventListener('touchend', handleEnd, { passive: true });
                    track.addEventListener('touchcancel', handleEnd, { passive: true });
                    
                    track.addEventListener('mousedown', handleStart);
                    const mouseMoveHandler = (e) => {
                        if (swipeConfirmItemState[index].isDragging) handleMove(e);
                    };
                    const mouseUpHandler = () => {
                        if (swipeConfirmItemState[index].isDragging) handleEnd();
                    };
                    document.addEventListener('mousemove', mouseMoveHandler);
                    document.addEventListener('mouseup', mouseUpHandler);
                    
                    handlers.mouseMoveHandler = mouseMoveHandler;
                    handlers.mouseUpHandler = mouseUpHandler;
                });
            }, 100);
        }
        
        // Функции редактирования для режима подтверждения
        function confirmStartEditQty(lineIndex) {
            confirmEditState[lineIndex] = true;
            renderConfirmChecklist(currentPrintShipment);
        }
        
        function confirmCancelEditQty(lineIndex) {
            // Восстанавливаем исходное значение, но сохраняем статус подтверждения
            const wasConfirmed = confirmChecklistState[lineIndex] && confirmChecklistState[lineIndex].confirmed;
            if (currentPrintShipment && currentPrintShipment.lines[lineIndex]) {
                const line = currentPrintShipment.lines[lineIndex];
                confirmChecklistState[lineIndex].collectedQty = line.collected_qty !== undefined ? line.collected_qty : line.qty;
                confirmChecklistState[lineIndex].confirmed = wasConfirmed || false;
            }
            confirmEditState[lineIndex] = false;
            renderConfirmChecklist(currentPrintShipment);
            updateConfirmProgress();
            
            // Переинициализируем swipe после редактирования
            setTimeout(() => {
                initSwipeToConfirmItem();
            }, 200);
        }
        
        function confirmConfirmEditQty(lineIndex) {
            confirmEditState[lineIndex] = false;
            // Обновляем collected_qty в исходных данных
            if (currentPrintShipment && currentPrintShipment.lines[lineIndex]) {
                currentPrintShipment.lines[lineIndex].collected_qty = confirmChecklistState[lineIndex].collectedQty;
            }
            renderConfirmChecklist(currentPrintShipment);
            updateConfirmProgress();
            
            // Переинициализируем swipe после редактирования
            setTimeout(() => {
                initSwipeToConfirmItem();
            }, 200);
        }
        
        function confirmAdjustQty(lineIndex, delta) {
            const wasConfirmed = confirmChecklistState[lineIndex] && confirmChecklistState[lineIndex].confirmed;
            
            if (!confirmChecklistState[lineIndex]) {
                const line = currentPrintShipment.lines[lineIndex];
                confirmChecklistState[lineIndex] = { 
                    qty: line.qty, 
                    collectedQty: line.collected_qty !== undefined ? line.collected_qty : line.qty,
                    confirmed: false
                };
            }
            
            const line = currentPrintShipment.lines[lineIndex];
            const currentQty = confirmChecklistState[lineIndex].collectedQty;
            const newQty = Math.max(0, Math.min(line.qty, currentQty + delta));
            
            // Сохраняем статус подтверждения перед обновлением
            if (wasConfirmed) {
                confirmChecklistState[lineIndex].confirmed = true;
            }
            
            confirmUpdateCollectedQty(lineIndex, newQty);
        }
        
        function confirmSetFullQty(lineIndex, maxQty) {
            confirmUpdateCollectedQty(lineIndex, maxQty);
        }
        
        function confirmUpdateCollectedQty(lineIndex, qty) {
            const wasConfirmed = confirmChecklistState[lineIndex] && confirmChecklistState[lineIndex].confirmed;
            
            if (!confirmChecklistState[lineIndex]) {
                const line = currentPrintShipment.lines[lineIndex];
                confirmChecklistState[lineIndex] = { 
                    qty: line.qty, 
                    collectedQty: line.collected_qty !== undefined ? line.collected_qty : line.qty,
                    confirmed: false
                };
            }
            
            const line = currentPrintShipment.lines[lineIndex];
            const maxQty = line.qty;
            const newQty = Math.min(Math.max(0, Math.floor(qty)), maxQty);
            
            confirmChecklistState[lineIndex].collectedQty = newQty;
            // Сохраняем статус подтверждения, если товар был подтвержден
            if (wasConfirmed) {
                confirmChecklistState[lineIndex].confirmed = true;
            }
            
            // Обновляем значение в input полях
            const mobileInput = document.getElementById(`confirm-qty-input-mobile-${lineIndex}`);
            const desktopInput = document.getElementById(`confirm-qty-input-${lineIndex}`);
            if (mobileInput) mobileInput.value = newQty;
            if (desktopInput) desktopInput.value = newQty;
            
            // Перерисовываем для обновления предупреждений
            renderConfirmChecklist(currentPrintShipment);
            updateConfirmProgress();
        }
        
        // Подтверждение отдельного товара
        function confirmItem(lineIndex) {
            if (!confirmChecklistState[lineIndex]) {
                const line = currentPrintShipment.lines[lineIndex];
                confirmChecklistState[lineIndex] = {
                    qty: line.qty,
                    collectedQty: line.collected_qty !== undefined ? line.collected_qty : line.qty,
                    confirmed: false
                };
            }
            
            confirmChecklistState[lineIndex].confirmed = true;
            renderConfirmChecklist(currentPrintShipment);
            updateConfirmProgress();
            
            // Переинициализируем swipe после подтверждения
            setTimeout(() => {
                initSwipeToConfirmItem();
            }, 200);
        }
        
        // Обновление прогресса подтверждения
        function updateConfirmProgress() {
            if (!currentPrintShipment || !currentPrintShipment.lines) return;
            
            const total = currentPrintShipment.lines.length;
            const confirmedCount = currentPrintShipment.lines.filter((_, index) => 
                confirmChecklistState[index] && confirmChecklistState[index].confirmed
            ).length;
            
            const progressEl = document.getElementById('confirm-progress');
            const confirmBtn = document.getElementById('confirm-shipment-btn');
            
            if (progressEl) {
                progressEl.textContent = `Подтверждено: ${confirmedCount}/${total}`;
            }
            
            // Блокируем кнопку подтверждения заказа, если не все товары подтверждены
            if (confirmBtn) {
                const allConfirmed = confirmedCount === total;
                confirmBtn.disabled = !allConfirmed;
                confirmBtn.classList.toggle('opacity-50', !allConfirmed);
                confirmBtn.classList.toggle('cursor-not-allowed', !allConfirmed);
                
                if (!allConfirmed) {
                    confirmBtn.title = `Подтвердите все товары (${confirmedCount}/${total})`;
                } else {
                    confirmBtn.title = '';
                }
            }
        }
        
        // Закрытие модального окна подтверждения
        function closeConfirmModal() {
            document.getElementById('confirm-modal').classList.add('hidden');
            document.body.style.overflow = '';
            currentPrintShipment = null;
            confirmEditState = {};
            confirmChecklistState = {};
        }
        
        // Подтверждение заказа проверяющим
        async function confirmShipment() {
            if (!currentPrintShipment) return;
            
            // Проверяем, что все товары подтверждены
            const total = currentPrintShipment.lines.length;
            const confirmedCount = currentPrintShipment.lines.filter((_, index) => 
                confirmChecklistState[index] && confirmChecklistState[index].confirmed
            ).length;
            
            if (confirmedCount !== total) {
                showToast(`Необходимо подтвердить все товары (${confirmedCount}/${total})`, 'error');
                return;
            }
            
            try {
                // Подготавливаем данные о собранных количествах (с учетом возможных изменений)
                const linesData = currentPrintShipment.lines.map((line, index) => ({
                    collected_qty: confirmChecklistState[index] ? confirmChecklistState[index].collectedQty : (line.collected_qty !== undefined ? line.collected_qty : line.qty)
                }));
                
                const response = await fetch(API_ENDPOINTS.confirmShipment(currentPrintShipment.id), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        lines: linesData
                    })
                });
                
                if (!response.ok) throw new Error('Ошибка при подтверждении заказа');
                
                // Обновляем статус локально и сохраняем обновленные количества
                const shipment = allShipments.find(s => s.id === currentPrintShipment.id);
                if (shipment) {
                    shipment.status = 'processed';
                    // Обновляем collected_qty в shipment.lines
                    if (shipment.lines && shipment.lines.length > 0) {
                        shipment.lines.forEach((line, index) => {
                            line.collected_qty = confirmChecklistState[index] ? confirmChecklistState[index].collectedQty : (line.collected_qty !== undefined ? line.collected_qty : line.qty);
                        });
                    }
                }
                
                updateCounters();
                closeConfirmModal();
                loadShipments();
                showToast('Заказ подтвержден и отправлен на офис', 'success');
            } catch (error) {
                console.error('Ошибка при подтверждении заказа:', error);
                showToast('Ошибка при подтверждении заказа', 'error');
            }
        }

        // Глобальные функции для вызова из HTML
        window.openCollectModal = openCollectModal;
        window.openConfirmModal = openConfirmModal;
        window.confirmStartEditQty = confirmStartEditQty;
        window.confirmCancelEditQty = confirmCancelEditQty;
        window.confirmConfirmEditQty = confirmConfirmEditQty;
        window.confirmAdjustQty = confirmAdjustQty;
        window.confirmSetFullQty = confirmSetFullQty;
        window.confirmUpdateCollectedQty = confirmUpdateCollectedQty;
        window.confirmItem = confirmItem;
        window.openDetailsModal = openDetailsModal;
        window.updateCollectChecklist = updateCollectChecklist;
        window.updateCollectedQty = updateCollectedQty;
        window.adjustQty = adjustQty;
        window.setFullQty = setFullQty;
        window.toggleCollected = toggleCollected;
        window.handleQtyInput = handleQtyInput;
        window.handleQtyKeydown = handleQtyKeydown;
        window.toggleLineChecked = toggleLineChecked;
        window.adjustDetailsQty = adjustDetailsQty;
        window.setDetailsFullQty = setDetailsFullQty;
        window.updateDetailsQty = updateDetailsQty;
        window.handleDetailsQtyInput = handleDetailsQtyInput;
        window.handleDetailsQtyKeydown = handleDetailsQtyKeydown;
        window.startEditQty = startEditQty;
        window.confirmEditQty = confirmEditQty;
        window.cancelEditQty = cancelEditQty;
        window.startDetailsEditQty = startDetailsEditQty;
        window.confirmDetailsEditQty = confirmDetailsEditQty;
        window.cancelDetailsEditQty = cancelDetailsEditQty;
        window.showNameTooltip = showNameTooltip;
        window.hideNameTooltip = hideNameTooltip;
    </script>

    <style>
        @keyframes slide-in {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .animate-slide-in {
            animation: slide-in 0.3s ease-out;
        }
    </style>
</body>
</html>

