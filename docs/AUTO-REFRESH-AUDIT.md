# Аудит: откуда берётся обновление страницы/данных

## Проблема

Страница или список заказов периодически обновляются, хотя уже есть обновления по SSE (Server-Sent Events). Это сбивает и мешает работе.

## Источники обновлений

### 1. **useShipments (главная страница — список заказов)**

**Файл:** `src/hooks/useShipments.ts`

| Что | Зачем | Частота |
|-----|--------|---------|
| `setInterval(loadShipments, 60000)` | «Резервное автообновление на случай проблем с SSE» | **Каждые 1 минуту** |
| `loadShipments()` по SSE `shipment:created` | После создания нового заказа подтянуть список (с debounce 3 сек) | По событию |
| `loadShipments()` при первом рендере | Начальная загрузка при авторизации | 1 раз |

**Итог:** раз в минуту список полностью перезапрашивается с сервера, скролл восстанавливается, но список перерисовывается — это и даёт ощущение «страница обновляется».

### 2. **Header (баллы и профиль)**

**Файл:** `src/components/layout/Header.tsx`

| Что | Зачем | Частота |
|-----|--------|---------|
| `setInterval(loadRankingStats, 30000)` | Обновление баллов/уровня в шапке и в выпадающем «Профиль» | **Каждые 30 секунд** |

**Итог:** не перезагружает список заказов, только запрос `/api/ranking/stats`. Может давать лёгкое «моргание» цифр в шапке.

### 3. **SSE (реальное время)**

**Файл:** `src/hooks/useSSE.ts`, обработка в `useShipments.ts`

- `shipment:locked` / `shipment:unlocked` — точечное обновление задания (lock/unlock).
- `shipment:status_changed` — обновление статуса заказа.
- `shipment:updated` — обновление задания (например, переход в «ожидание подтверждения»).
- `shipment:created` — новый заказ; сейчас через 3 сек вызывается **полный** `loadShipments()`.

Обновления по SSE не требуют полной перезагрузки списка, кроме `shipment:created`, где специально делается полный refetch.

### 4. **Явные вызовы refreshShipments (после действий пользователя)**

**Файл:** `src/app/page.tsx`

- После подтверждения задания (confirm).
- После «собрать всё» (collect all).
- После сброса прогресса сборки/проверки.
- После удаления сборки.
- После отправки в офис (успех или ошибка).

Это обосновано: пользователь только что изменил данные, список нужно подтянуть.

### 5. **Другие интервалы**

- `useCollect.ts` — heartbeat при открытом модале сборки (не трогает список).
- `StatisticsTab.tsx` (админка) — свой интервал обновления статистики.
- `api/shipments/events` — heartbeat SSE раз в 30 сек (не триггерит refetch на клиенте).

## Рекомендации (что поправить)

1. **Убрать минутное автообновление списка в useShipments**  
   Удалить `setInterval(loadShipments, 60000)`. Обновление списка заказов — по SSE и по кнопке «Обновить» (и после явных действий пользователя). Если SSE отвалится, пользователь может нажать «Обновить» вручную.

2. **По желанию: реже обновлять баллы в шапке**  
   Увеличить интервал в Header с 30 до 60–120 секунд или обновлять баллы только при открытии «Профиль», чтобы не отвлекать.

3. **shipment:created**  
   Оставить как есть (полный refetch с debounce 3 сек) или в будущем заменить на добавление одного заказа в state по данным из SSE, если в событии будет полный объект заказа.

## Внесённые изменения

1. **useShipments.ts** — удалён интервал резервного автообновления раз в 1 минуту. Список заказов обновляется только при первой загрузке, по событиям SSE и по кнопке «Обновить» (и после действий пользователя: подтверждение, сброс, отправка в офис и т.д.).
2. **Header.tsx** — интервал обновления баллов в шапке увеличен с 30 до 60 секунд, чтобы реже перерисовывать шапку.
