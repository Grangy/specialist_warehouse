# Аудит: ранг (животные) на странице /top — за день или за месяц?

## Вопрос

На странице «Общий топ дня» (/top) ранг в виде животных показывает общий за месяц, а не за сегодня. Почему так и как поправить?

## Как устроено сейчас

### Страница /top

- **Файл:** `src/app/top/page.tsx`
- Запрашивает **только** `GET /api/statistics/top` (без параметров period).
- В ответе использует `data.all` и `data.date`. Для каждого участника отображает `user.rank` и `user.level` (животное).

### API /api/statistics/top

- **Файл:** `src/app/api/statistics/top/route.ts`
- **Период данных:** только сегодня:
  - `startDate` = начало текущего дня (00:00:00),
  - `endDate` = текущий момент (23:59:59 того же дня).
- Выборка:
  - сборщики: `TaskStatistics` за сегодня по `task.completedAt`;
  - проверяльщики: по `task.confirmedAt` за сегодня;
  - сборки проверяльщиков: по `task.completedAt` за сегодня (роль collector, user.role = checker).
- **Диктовщики:** в топе **не учитывались** — баллы сборщика как диктовщика (по `confirmedAt`, `dictatorId`) не попадали в агрегат. В `/api/statistics/ranking` они учитываются.
- Ранг и уровень:
  - массив `allRankings` строится из **сегодняшних** баллов (points);
  - `allPoints` = массив баллов за сегодня;
  - процентили считаются по этому массиву (0.1 … 0.9);
  - каждому участнику назначается `rank` (1–10) по правилу `entry.points <= percentiles[i]` → rank = i+1;
  - `level` = `getAnimalLevel(rank)` — только от этого ранга за сегодня.

То есть в коде **ранг и животные в /api/statistics/top считаются строго по данным за день** (startDate/endDate = сегодня). Отдельного использования месячных данных в этом эндпоинте нет.

## Возможные причины, почему кажется «за месяц»

1. **Путаница с админкой**  
   В админке вкладка «Статистика» вызывает `GET /api/statistics/ranking?period=...` (today/week/month). При выборе «Месяц» ранг там действительно за месяц. Страница /top с этим API не связана и вызывает только `/api/statistics/top`.

2. **Кэш**  
   Браузер или прокси могли отдавать старый ответ. На фронте уже стоит `cache: 'no-store'` для запроса к `/api/statistics/top`.

3. **Разные баллы из‑за диктовщиков**  
   В топе не учитывались баллы диктовщика. У сборщика, который часть дня работал диктовщиком, баллы на /top были ниже, чем в профиле/рейтинге, поэтому ранг (и животное) на /top могли выглядеть «не как за день» — на самом деле это был другой расчёт по тому же дню, а не месяц.

## Что сделано

1. **Явная привязка к дню в коде**  
   В `/api/statistics/top` добавлены комментарии, что ранг и уровень считаются **только по данным за текущий день** (today), и что для общего топа дня не используется период month/week.

2. **Учёт диктовщиков в топе**  
   В `/api/statistics/top` добавлена агрегация баллов «сборщик как диктовщик» (TaskStatistics с `roleType: 'collector'`, `task.confirmedAt` за сегодня, `task.dictatorId = user.id`). Так баллы и ранг на /top совпадают с логикой «топа дня» в профиле и в `/api/statistics/ranking` (period=today).

После этих правок ранг в виде животных на странице /top гарантированно считается по данным за сегодня и не использует месячный рейтинг.
