# Безопасность скриптов (scripts/)

Краткий аудит скриптов на типичные уязвимости: SQL-инъекции, подстановка путей, утечка секретов, небезопасный spawn/exec.

## Результаты аудита

### 1. SQL-инъекции (`$queryRawUnsafe`)

Во всех скриптах запросы к БД через `$queryRawUnsafe` используют **фиксированный текст SQL** — в строку запроса не подставляются `process.argv`, `process.env` или пользовательский ввод.

- **audit-art-in-db.ts** — единственная «динамика»: `LIMIT ${RANDOM_SAMPLE_SIZE}`, где `RANDOM_SAMPLE_SIZE = 20` (константа). Риска нет.
- **audit-db-what-happened.ts**, **audit-export-1c.ts**, **apply-art-from-base.ts**, **export-art-by-name.ts**, **restore-art-from-name.ts** — только статичные запросы.

**Вывод:** SQL-инъекций в текущем коде не выявлено.

---

### 2. Пользовательский ввод в запросах

- **audit-user-detailed.ts** — `userName` из `process.argv[2]` используется только в JS: `allUsers.find(u => u.name.toLowerCase().includes(userName.toLowerCase()))`. В SQL не попадает (используется Prisma API с фиксированным `where`). Риска нет.

---

### 3. Путь к файлу из аргументов (path traversal)

- **restore-database.ts** (и **restore-database.js**) — путь к бэкапу берётся из `process.argv[2]` и передаётся в `fs.readFileSync(backupFile)`. Злоумышленник может указать путь вроде `../../../etc/passwd` и прочитать произвольный файл. Если файл окажется валидным JSON в формате бэкапа — его данные будут импортированы в БД.

**Исправление:** в `restore-database.ts` путь к бэкапу разрешается относительно корня проекта (`projectRoot`), и разрешены только пути **внутри проекта**. Пути вида `../../../etc/passwd` отклоняются.

---

### 4. Секреты (пароли) в аргументах

- **verify-import.ts** — пароль может передаваться как `process.argv[4]`. В лог пароль не пишется, но в списке процессов (`ps`) аргументы видны, поэтому пароль может утечь.

**Рекомендация:** предпочитать переменную окружения `API_PASSWORD` и в справке указывать: «пароль передавайте через `API_PASSWORD`, не через аргумент».

- **import-data-from-api.ts** — пароль через `--password`; в консоль не выводится. Та же рекомендация: в прод/на сервере лучше передавать пароль через env.

---

### 5. `spawn` / `child_process`

- **import-data-from-api.ts** — вызывается `spawn('npx', ['tsx', 'scripts/recalculate-ranks.ts'], ...)`. Команда и аргументы зашиты в коде, пользовательский ввод в них не подставляется. Риска нет.

---

### 6. Пути к БД и к файлам

- **DATABASE_URL** из `process.env` — типичная конфигурация для скриптов; не считается пользовательским вводом при нормальном развёртывании.
- **apply-art-from-base.ts** — путь к базе артикулов: `path.join(process.cwd(), 'scripts', ART_BASE_FILENAME)` (фиксированное имя файла). Риска нет.

---

## Сводка

| Риск | Скрипт | Статус |
|------|--------|--------|
| SQL-инъекция | Все с `$queryRawUnsafe` | Нет — запросы статичны или с константами |
| Path traversal | restore-database.ts / .js | Исправлено — путь ограничен директорией проекта |
| Утечка пароля в argv | verify-import.ts | Низкий — предпочитать API_PASSWORD |
| Небезопасный spawn | import-data-from-api.ts | Нет — команда фиксирована |

Рекомендуемые изменения: ограничить путь к бэкапу в `restore-database.ts` и в справке/скриптах явно рекомендовать передавать пароль через переменные окружения.
