# Восстановление БД и артикулов

## Откат БД «до миграции»

Миграция `20251225101019_add_art_field_to_shipment_line` **только добавляет** колонку `art` в таблицу `shipment_lines`:

```sql
ALTER TABLE "shipment_lines" ADD COLUMN "art" TEXT;
```

Она **ничего не удаляет и не переносит**. Если на сервере во всех строках `art = NULL`, значит артикулы в эту БД никогда не записывались (заказы создавались без поля `art` или выгрузка из 1С его не передаёт).

### Как откатить БД к состоянию «до этой миграции»

1. **Нужен файловый бэкап** базы (например `prisma/dev.db` или `prisma/production.db`) с того момента, когда миграция ещё не была применена.
2. Остановить приложение, подменить файл БД на бэкап, запустить приложение.
3. После отката в базе **не будет колонки `art`**. Если снова выполнить `npx prisma migrate deploy`, миграция снова добавит колонку (пустую). То есть откат к «до миграции» **не восстанавливает артикулы** — их в том состоянии и не было в этой копии БД.

**Итог:** откат к «до миграции» имеет смысл только если вы хотите убрать колонку и откатить все изменения после бэкапа. Чтобы именно **появились артикулы**, нужен либо бэкап, где они уже были заполнены, либо восстановление из другого источника (см. ниже).

---

## Восстановление артикулов

### 1. Восстановление из поля `name` (эвристика)

Во многих позициях артикул дублируется в начале названия (например: `211015 Сверло...`, `А-43 Перчатки...`). Скрипт пытается взять первый «токен» из `name` и записать его в `art`, если он похож на артикул (есть цифра или паттерн типа `А-43`).

**Запуск (сначала только просмотр):**
```bash
npx tsx scripts/restore-art-from-name.ts
```

**Запись в БД:**
```bash
npx tsx scripts/restore-art-from-name.ts --apply
```

После выполнения проверка: `npm run audit:art`.

### 2. База артикулов по названию (JSON): локаль → сервер

Безопасный способ: собрать на локальной БД (где артикулы есть) базу «название → артикул», выгрузить её на сервер и по ней заполнить артикулы только у активных/завершённых заказов.

**Шаг 1 — локально:** экспорт из локальной БД в JSON:
```bash
npm run export:art
# или: npx tsx scripts/export-art-by-name.ts
```
Создаётся/обновляется файл `scripts/art-by-name-base.json` (нормализованные названия → артикул).

**Шаг 2:** загрузить этот файл на сервер (git, scp и т.п.), чтобы на сервере был путь `scripts/art-by-name-base.json`.

**Шаг 3 — на сервере:** применить базу к строкам без артикула (только заказы со статусами new, pending_confirmation, processed, confirmed и не удалённые):
```bash
# Сначала только просмотр
npm run apply:art
# или: npx tsx scripts/apply-art-from-base.ts

# Запись в БД
npx tsx scripts/apply-art-from-base.ts --apply
```

Сопоставление по **нормализованному названию** (пробелы сжаты, trim). Обновляются только строки, у которых артикул пустой и заказ подходит по статусу.

### 3. Восстановление из бэкапа, где артикулы уже есть

Если есть копия БД (например с другой машины), где в `shipment_lines` заполнено поле `art`:

- можно подставить эту БД вместо текущей (полная замена), или
- выгрузить из бэкапа пары `(id, art)` или `(shipment_id, sku, art)` и обновить текущую БД по совпадению `id` или `(shipment_id, sku)`.

### 4. Дальше: откуда брать артикулы при создании заказов

Чтобы новые заказы приходили с артикулами, источник данных (1С или другой импорт) при создании заказа (POST `/api/shipments`) должен передавать в каждой строке поле `art`. В коде оно уже сохраняется: `art: line.art || null` при создании позиций.
