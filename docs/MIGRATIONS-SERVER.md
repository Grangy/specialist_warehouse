# Миграции на сервере: как применять, чтобы ничего не отвалилось

## Главное правило

**Миграция должна применяться к той же базе, к которой подключается приложение.**

И приложение, и команда `prisma migrate deploy` берут путь к БД из переменной **DATABASE_URL**. Если у них разные значения (разные .env, разное окружение), миграция изменит один файл БД, а приложение будет читать другой — и появятся ошибки вида «column does not exist».

---

## Как правильно применить миграции на сервере

### 1. Убедиться, откуда приложение берёт DATABASE_URL

На сервере приложение (Next.js / PM2 / systemd) обычно запускается из **корня проекта** и подхватывает `.env` из этой папки. В `.env` должна быть строка:

```env
DATABASE_URL="file:./prisma/dev.db"
```

или абсолютный путь к файлу БД на сервере, например:

```env
DATABASE_URL="file:/var/www/sklad_spec/prisma/dev.db"
```

Запомните: **именно этот путь** должен использовать миграция.

### 2. Запускать миграцию из корня проекта с тем же .env

Перейдите в каталог проекта и выполните миграцию **без переопределения** DATABASE_URL:

```bash
cd /путь/к/проекту/sklad_spec
npx prisma migrate deploy
```

При этом в текущей директории должен лежать тот же `.env`, из которого запускается приложение (с тем же `DATABASE_URL`). Тогда Prisma подключится к той же БД, что и приложение.

### 3. Если на сервере нет .env в проекте

Если переменные задаются через systemd, PM2 env или другой менеджер, то и миграцию нужно запускать так, чтобы она видела тот же `DATABASE_URL`. Варианты:

**Вариант A — подставить URL явно (если знаете путь к БД):**

```bash
cd /путь/к/проекту/sklad_spec
DATABASE_URL="file:/полный/путь/к/prisma/dev.db" npx prisma migrate deploy
```

Подставьте тот же путь, который использует приложение.

**Вариант B — использовать .env приложения:**

```bash
cd /путь/к/проекту/sklad_spec
set -a && source .env && set +a   # Linux/macOS: загрузить .env в текущую оболочку
npx prisma migrate deploy
```

Так миграция увидит тот же `DATABASE_URL`, что и приложение.

### 4. После деплоя нового кода (с новой миграцией)

Рекомендуемый порядок:

1. Остановить приложение (или перевести в режим обслуживания).
2. Выполнить `npx prisma migrate deploy` из корня проекта с правильным `DATABASE_URL` (см. выше).
3. Убедиться, что команда завершилась без ошибок.
4. Запустить приложение снова.

Так вы избежите ситуации, когда приложение уже обращается к новой схеме (по новому коду), а миграция ещё не применена.

---

## Локальная разработка

Та же логика: миграция и приложение должны использовать один и тот же `DATABASE_URL`.

- Обычно в корне проекта лежит `.env` с `DATABASE_URL="file:./prisma/dev.db"`.
- Запускайте миграции из корня проекта: `npx prisma migrate deploy` или `npx prisma migrate dev`.
- Не задавайте в системе (или в другом .env) другой `DATABASE_URL`, иначе получите две разные базы (как было с `pinned_at`).

---

## Проверка после миграции

Убедиться, что колонка/таблица появилась в нужной БД:

```bash
# Для SQLite (подставьте путь к вашему dev.db)
sqlite3 prisma/dev.db "PRAGMA table_info(shipments);"
```

В списке должна быть нужная колонка (например, `pinned_at`).

---

## Итог

| Где        | Действие |
|-----------|----------|
| Сервер    | Запускать `npx prisma migrate deploy` из корня проекта, с тем же `.env` / `DATABASE_URL`, что и у приложения. Перед деплоем нового кода — сначала миграция, потом перезапуск приложения. |
| Локально  | Запускать миграции из корня проекта, не переопределять `DATABASE_URL` в окружении, чтобы не было двух разных баз. |
