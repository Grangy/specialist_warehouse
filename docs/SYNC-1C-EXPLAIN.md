# Sync-1C: что значит success: false и как «поправить»

## Как работает Sync-1C

1. **1С дергает нас:** `POST /api/shipments/sync-1c` с телом `{ orders: [ { id, number?, success } ] }`.
2. **Мы обновляем БД только при success: true:** для таких заказов ставим `exportedTo1C = true`, `exportedTo1CAt = now`. При `success: false` мы **ничего не меняем** — просто пропускаем.
3. **В ответе мы отдаём** список заказов «готовых к выгрузке» (processed, не удалён, ещё не помечен как выгруженный в 1С). 1С их забирает и обрабатывает у себя.

То есть **инициатор всегда 1С**: он нам шлёт статусы, мы не шлём ему «всё ок». Мы только отдаём список заказов для выгрузки.

## Что значит, что 1С присылает 37 заказов с success: false

Это значит: **1С сообщает по каждому из этих заказов «мы не подтверждаем успешную обработку»**.

Возможные причины:

1. **1С ещё не обработал** — он периодически запрашивает у нас «ready for export», получает эти заказы, но по какой-то причине не ставит у себя success и не шлёт обратно success: true (ошибка в 1С, таймаут, другая логика).
2. **1С обработал с ошибкой** — попытался принять заказы и всем вернул success: false.
3. **1С шлёт «список известных id»** — при каждом запросе отдаёт все id, которые когда-то получал от нас, с success: false, пока сам не обновит их на true после обработки. Тогда цикл нормальный, просто 1С пока не прислал success: true.

В любом случае **мы не можем «один раз отправить 1С что всё ок»** — в этом API мы только принимаем от 1С и отдаём список готовых к выгрузке. «Подтверждение» идёт только от 1С к нам (success: true).

## Что можно сделать на нашей стороне

Если решено **считать эти заказы уже выгруженными** (чтобы они больше не попадали в «ready for export» и 1С перестал их получать и слать обратно с success: false):

- Пометить их у нас как выгруженные в 1С: `exportedTo1C = true`, `exportedTo1CAt = now`.
- Тогда в ответе sync-1c они не будут в списке «ready for export», цикл по ним прекратится.

Варианты:

1. **По одному через админку** — в предупреждениях 1С есть кнопка «Пометить выгруженным в 1С» (вызов `POST /api/shipments/[id]/mark-exported-1c`).
2. **Скрипт один раз** — из корня проекта:
   - по списку id из лога 1С: `npx tsx scripts/mark-shipments-exported-1c.ts --ids id1,id2,id3,...`;
   - все такие заказы разом: `npx tsx scripts/mark-shipments-exported-1c.ts --all` (все processed и ещё не помеченные как выгруженные).

3. **Автоматически в Sync-1C** — любой заказ из запроса 1С (и с `success: true`, и с `success: false`), если он есть в БД со статусом processed и не удалён, помечается как выгруженный. После следующего вызова 1С эти заказы перестанут отдаваться в ready-for-export.

4. **Заказа нет у нас в БД (удалён вручную и т.п.), а 1С ещё шлёт** — в ответе временно добавлено поле **`success_ids`**: массив id заказов, которых у нас нет или они удалены. Мы отдаём их как «успех» для 1С, чтобы 1С убрал их из своего списка **без доработок в 1С**. Потом логику можно вернуть как было и убрать `success_ids`.

После пометки мы перестаём отдавать эти заказы в sync-1c. Если 1С продолжит слать те же id с success: false — мы просто не будем по ним ничего обновлять (и не будем снова отдавать их в ready for export).
