/**
 * Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð¿Ð¾Ð¼ÐµÑ‚ÐºÐ¸ Ð²ÑÐµÑ… ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ñ… Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ñ‹Ñ… Ð·Ð°ÐºÐ°Ð·Ð¾Ð² ÐºÐ°Ðº Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ… Ð² 1Ð¡
 * 
 * Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ:
 *   tsx scripts/mark-all-processed-as-exported.ts
 * 
 * Ð˜Ð»Ð¸ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ:
 *   npx tsx scripts/mark-all-processed-as-exported.ts
 */

import { PrismaClient } from '../src/generated/prisma/client';
import path from 'path';

// ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿ÑƒÑ‚Ð¸ Ðº Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…
const databaseUrl = process.env.DATABASE_URL || 'file:./prisma/dev.db';
let finalDatabaseUrl = databaseUrl;

if (databaseUrl?.startsWith('file:./')) {
  const dbPath = databaseUrl.replace('file:', '');
  const absolutePath = path.join(process.cwd(), dbPath);
  finalDatabaseUrl = `file:${absolutePath}`;
} else if (databaseUrl?.startsWith('file:')) {
  // Ð•ÑÐ»Ð¸ Ð¿ÑƒÑ‚ÑŒ ÑƒÐ¶Ðµ Ð°Ð±ÑÐ¾Ð»ÑŽÑ‚Ð½Ñ‹Ð¹, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÐºÐ°Ðº ÐµÑÑ‚ÑŒ
  finalDatabaseUrl = databaseUrl;
}

const prisma = new PrismaClient({
  datasources: {
    db: {
      url: finalDatabaseUrl,
    },
  },
});

async function main() {
  console.log('ðŸ”„ ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ Ð¿Ð¾Ð¼ÐµÑ‚ÐºÑƒ Ð²ÑÐµÑ… Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ñ‹Ñ… Ð·Ð°ÐºÐ°Ð·Ð¾Ð² ÐºÐ°Ðº Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ… Ð² 1Ð¡...\n');

  // ÐÐ°Ñ…Ð¾Ð´Ð¸Ð¼ Ð²ÑÐµ Ð·Ð°ÐºÐ°Ð·Ñ‹ ÑÐ¾ ÑÑ‚Ð°Ñ‚ÑƒÑÐ¾Ð¼ 'processed', ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ ÐµÑ‰Ðµ Ð½Ðµ Ð±Ñ‹Ð»Ð¸ ÑÐºÑÐ¿Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹
  const shipments = await prisma.shipment.findMany({
    where: {
      status: 'processed',
      exportedTo1C: false,
    },
    select: {
      id: true,
      number: true,
      status: true,
      exportedTo1C: true,
    },
  });

  console.log(`ðŸ“¦ ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ Ð·Ð°ÐºÐ°Ð·Ð¾Ð² Ð´Ð»Ñ Ð¿Ð¾Ð¼ÐµÑ‚ÐºÐ¸: ${shipments.length}\n`);

  if (shipments.length === 0) {
    console.log('âœ… ÐÐµÑ‚ Ð·Ð°ÐºÐ°Ð·Ð¾Ð² Ð´Ð»Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ. Ð’ÑÐµ Ð·Ð°ÐºÐ°Ð·Ñ‹ ÑƒÐ¶Ðµ Ð¿Ð¾Ð¼ÐµÑ‡ÐµÐ½Ñ‹ ÐºÐ°Ðº Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ.');
    return;
  }

  // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð²ÑÐµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð½Ñ‹Ðµ Ð·Ð°ÐºÐ°Ð·Ñ‹
  const result = await prisma.shipment.updateMany({
    where: {
      status: 'processed',
      exportedTo1C: false,
    },
    data: {
      exportedTo1C: true,
      exportedTo1CAt: new Date(),
    },
  });

  console.log(`âœ… ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾ Ð·Ð°ÐºÐ°Ð·Ð¾Ð²: ${result.count}\n`);

  // Ð’Ñ‹Ð²Ð¾Ð´Ð¸Ð¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ñ… Ð·Ð°ÐºÐ°Ð·Ð¾Ð²
  if (shipments.length > 0) {
    console.log('ðŸ“‹ Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ñ… Ð·Ð°ÐºÐ°Ð·Ð¾Ð²:');
    shipments.forEach((shipment, index) => {
      console.log(`  ${index + 1}. ${shipment.number} (ID: ${shipment.id})`);
    });
  }

  console.log('\nâœ… Ð“Ð¾Ñ‚Ð¾Ð²Ð¾! Ð’ÑÐµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ñ‹Ðµ Ð·Ð°ÐºÐ°Ð·Ñ‹ Ð¿Ð¾Ð¼ÐµÑ‡ÐµÐ½Ñ‹ ÐºÐ°Ðº Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð² 1Ð¡.');
  console.log('ðŸ“ Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½Ð¾Ð²Ñ‹Ðµ Ð·Ð°ÐºÐ°Ð·Ñ‹ Ð±ÑƒÐ´ÑƒÑ‚ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°Ñ‚ÑŒÑÑ Ð² endpoint sync-1c.\n');
}

main()
  .catch((e) => {
    console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ð¸ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð°:', e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });

