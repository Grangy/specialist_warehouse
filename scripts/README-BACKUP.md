# Скрипты резервного копирования базы данных

## Описание

Скрипты для создания и восстановления резервных копий базы данных проекта.

## Создание резервной копии

### На сервере (рекомендуется):

**Вариант 1: Через tsx (самый надежный)**
```bash
# Убедитесь, что tsx установлен: npm install -g tsx
tsx scripts/backup-database.ts
```

**Вариант 2: Через npx tsx**
```bash
npx tsx scripts/backup-database.ts
```

**Вариант 3: Через npm скрипт**
```bash
npm run db:backup
```

**Вариант 4: Через bash скрипт (автоматически выберет tsx)**
```bash
./scripts/backup-database-server.sh
```

**Вариант 5: Через bash скрипт (копия файла БД)**
```bash
./scripts/backup-database.sh
```

## Восстановление из резервной копии

### На сервере (рекомендуется):

**Вариант 1: Через tsx**
```bash
tsx scripts/restore-database.ts backups/backup_2026-01-26T10-41-39.json
```

**Вариант 2: Через npx tsx**
```bash
npx tsx scripts/restore-database.ts backups/backup_2026-01-26T10-41-39.json
```

**Вариант 3: Через npm скрипт**
```bash
npm run db:restore backups/backup_2026-01-26T10-41-39.json
```

## Что сохраняется

Скрипт создает полную резервную копию всех данных из базы данных:
- Пользователи
- Заказы (shipments)
- Позиции заказов (shipment_lines)
- Задания (shipment_tasks)
- Позиции заданий (shipment_task_lines)
- Блокировки
- Сессии
- Приоритеты регионов
- Статистика (task_statistics, daily_stats, monthly_stats)
- Нормативы
- Достижения
- Системные настройки

## Где сохраняются бэкапы

- **Разовый бэкап** (`npm run db:backup`): директория `backups/` в корне проекта.
- **Планировщик** (`npm run db:backup:scheduled`):
  - `backups/30m/` — бэкапы каждые 30 минут, хранятся последние **10** копий;
  - `backups/5h/` — раз в 5 часов та же копия дополнительно сохраняется сюда, хранятся **2** копии.

Каждый бэкап: `backup_YYYY-MM-DDTHH-MM-SS.json` — JSON со всеми данными (как у разового бэкапа).

## Важные замечания

⚠️ **ВНИМАНИЕ**: Восстановление из бэкапа **удалит все текущие данные** в базе!

Перед восстановлением:
1. Убедитесь, что у вас есть актуальная резервная копия
2. Остановите приложение
3. Запустите восстановление
4. Проверьте данные после восстановления

## Планировщик бэкапов (каждые 30 мин + 2 копии по 5 ч)

Долгоиграющий процесс: бэкап каждые 30 минут, хранение 10 копий в `backups/30m/`; раз в 5 часов та же копия пишется в `backups/5h/`, хранятся 2 копии.

```bash
npm run db:backup:scheduled
# или
npx tsx scripts/backup-database-scheduled.ts
```

Остановка: Ctrl+C. Для работы в фоне используйте screen/tmux или systemd.

## Автоматическое резервное копирование (cron)

Разовый бэкап по расписанию:

```bash
# Каждый день в 3:00 ночи
0 3 * * * cd /path/to/project && npm run db:backup >> /var/log/backup.log 2>&1
```

## Восстановление на сервере

1. Скопируйте файл бэкапа на сервер
2. Остановите приложение
3. Запустите восстановление:
   ```bash
   npm run db:restore backups/backup_YYYY-MM-DDTHH-MM-SS.json
   ```
4. Запустите приложение
5. Проверьте, что все работает корректно
