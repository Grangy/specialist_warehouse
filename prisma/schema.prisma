// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum UserRole {
  admin
  collector
  checker
}

enum ShipmentStatus {
  new
  pending_confirmation
  processed
  confirmed
}

model User {
  id        String          @id @default(cuid())
  login     String          @unique
  password  String
  name      String
  role      UserRole        @default(collector)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  sessions  Session[]
  collectorTasks ShipmentTask[] @relation("CollectorTasks") // Задания, начатые пользователем как сборщик
  checkerTasks   ShipmentTask[] @relation("CheckerTasks") // Задания, подтвержденные пользователем как проверяльщик

  @@map("users")
}

model Shipment {
  id              String          @id @default(cuid())
  number          String          @unique
  createdAt       DateTime        @default(now()) @map("created_at")
  customerName    String          @map("customer_name")
  destination     String
  itemsCount      Int             @map("items_count")
  totalQty        Int             @map("total_qty")
  weight          Float?
  comment         String          @default("")
  status          ShipmentStatus  @default(new)
  businessRegion  String?         @map("business_region")
  collectorName   String?         @map("collector_name")
  confirmedAt     DateTime?       @map("confirmed_at") // Время подтверждения заказа (когда все задания подтверждены)
  exportedTo1C    Boolean         @default(false) @map("exported_to_1c") // Флаг выгрузки заказа в 1С
  exportedTo1CAt  DateTime?       @map("exported_to_1c_at") // Время выгрузки заказа в 1С
  places          Int?            // Количество мест (сохраняется при отправке в офис)
  lines           ShipmentLine[]
  tasks           ShipmentTask[]
  locks           ShipmentLock[]

  @@map("shipments")
}

model ShipmentLine {
  id           String            @id @default(cuid())
  shipmentId   String            @map("shipment_id")
  sku          String
  name         String
  qty          Int
  uom          String
  location     String?
  warehouse    String?           // Склад: "Склад 1", "Склад 2", "Склад 3"
  collectedQty Int?              @map("collected_qty") // Количество собранное сборщиком
  checked      Boolean           @default(false) // Флаг собранности (для сборки)
  confirmedQty Int?             @map("confirmed_qty") // Количество подтвержденное проверяльщиком
  confirmed   Boolean           @default(false) // Флаг подтверждения (для проверки)
  shipment     Shipment          @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  taskLines    ShipmentTaskLine[]

  @@map("shipment_lines")
}

model ShipmentLock {
  id         String   @id @default(cuid())
  shipmentId String   @map("shipment_id")
  userId     String   @map("user_id")
  lockedAt   DateTime @default(now()) @map("locked_at")
  shipment   Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  @@unique([shipmentId])
  @@map("shipment_locks")
}

model ShipmentTask {
  id           String            @id @default(cuid())
  shipmentId   String            @map("shipment_id")
  warehouse    String            // "Склад 1", "Склад 2", "Склад 3"
  status       ShipmentStatus    @default(new)
  createdAt    DateTime          @default(now()) @map("created_at")
  collectorName String?          @map("collector_name")
  collectorId  String?           @map("collector_id") // ID пользователя, начавшего сборку
  startedAt   DateTime?         @map("started_at") // Время начала сборки
  completedAt DateTime?         @map("completed_at") // Время завершения сборки (когда переведено в pending_confirmation)
  checkerName  String?           @map("checker_name") // Имя проверяльщика
  checkerId    String?           @map("checker_id") // ID проверяльщика
  confirmedAt DateTime?         @map("confirmed_at") // Время подтверждения задания проверяльщиком
  totalItems  Int?              @map("total_items") // Общее количество позиций в задании
  totalUnits  Int?              @map("total_units") // Общее количество единиц в задании
  timePer100Items Float?        @map("time_per_100_items") // Время на 100 позиций в секундах
  shipment     Shipment          @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  collector    User?             @relation("CollectorTasks", fields: [collectorId], references: [id], onDelete: SetNull)
  checker      User?             @relation("CheckerTasks", fields: [checkerId], references: [id], onDelete: SetNull)
  lines        ShipmentTaskLine[]
  locks        ShipmentTaskLock[]

  @@map("shipment_tasks")
}

model ShipmentTaskLine {
  id             String        @id @default(cuid())
  taskId         String        @map("task_id")
  shipmentLineId String        @map("shipment_line_id")
  qty            Int           // Количество в этом задании
  collectedQty   Int?           @map("collected_qty") // Количество собранное сборщиком
  checked        Boolean       @default(false) // Флаг собранности (для сборки)
  confirmedQty   Int?          @map("confirmed_qty") // Количество подтвержденное проверяльщиком
  confirmed      Boolean       @default(false) // Флаг подтверждения (для проверки)
  task           ShipmentTask  @relation(fields: [taskId], references: [id], onDelete: Cascade)
  shipmentLine   ShipmentLine  @relation(fields: [shipmentLineId], references: [id], onDelete: Cascade)

  @@map("shipment_task_lines")
}

model ShipmentTaskLock {
  id         String        @id @default(cuid())
  taskId     String        @map("task_id")
  userId     String        @map("user_id")
  lockedAt   DateTime      @default(now()) @map("locked_at")
  task       ShipmentTask  @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([taskId])
  @@map("shipment_task_locks")
}

model Session {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model RegionPriority {
  id        String   @id @default(cuid())
  region    String   @unique // Название региона (например, "Москва")
  priority  Int      @default(0) // Приоритет: чем меньше число, тем выше приоритет
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("region_priorities")
}
